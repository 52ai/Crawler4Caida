{"version":3,"sources":["../../../../src/lib/batches/table-batch-builder.ts"],"names":["BaseTableBatchAggregator","RowTableBatchAggregator","ColumnarTableBatchAggregator","DEFAULT_OPTIONS","shape","batchSize","batchDebounceMs","limit","_limitMB","ERR_MESSAGE","TableBatchBuilder","constructor","schema","options","Date","now","limitReached","Boolean","totalLength","totalBytes","addRow","row","rowBytes","_estimateRowMB","Array","isArray","addArrayRow","addObjectRow","aggregator","TableBatchType","_getTableBatchType","chunkComplete","chunk","ArrayBuffer","bytesUsed","byteLength","length","isChunkComplete","getFullBatch","_isFull","_getBatch","getFinalBatch","Object","keys","rowCount","lastBatchEmittedMs","normalizedBatch","getBatch","count","batchCount","assign","ArrowBatch","Error"],"mappings":"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","sourcesContent":["import type {Schema} from '../schema/schema';\nimport type {TableBatch} from '../../category/table/table-types';\nimport type {TableBatchAggregator, TableBatchConstructor} from './table-batch-aggregator';\nimport BaseTableBatchAggregator from './base-table-batch-aggregator';\nimport RowTableBatchAggregator from './row-table-batch-aggregator';\nimport ColumnarTableBatchAggregator from './columnar-table-batch-aggregator';\n\n// TODO define interface instead\ntype TableBatchBuilderOptions = {\n  shape: 'row-table' | 'array-row-table' | 'object-row-table' | 'columnar-table' | 'arrow-table';\n  batchSize?: number | 'auto';\n  batchDebounceMs?: number;\n  limit: number;\n  _limitMB: number;\n};\n\ntype GetBatchOptions = {\n  bytesUsed?: number;\n  [key: string]: any;\n};\n\nconst DEFAULT_OPTIONS: Required<TableBatchBuilderOptions> = {\n  shape: 'array-row-table',\n  batchSize: 'auto',\n  batchDebounceMs: 0,\n  limit: 0,\n  _limitMB: 0\n};\n\nconst ERR_MESSAGE = 'TableBatchBuilder';\n\n/** Incrementally builds batches from a stream of rows */\nexport default class TableBatchBuilder {\n  schema: Schema;\n  options: Required<TableBatchBuilderOptions>;\n\n  private aggregator: TableBatchAggregator | null = null;\n  private batchCount: number = 0;\n  private bytesUsed: number = 0;\n  private isChunkComplete: boolean = false;\n  private lastBatchEmittedMs: number = Date.now();\n  private totalLength: number = 0;\n  private totalBytes: number = 0;\n  private rowBytes: number = 0;\n\n  static ArrowBatch?: TableBatchConstructor;\n\n  constructor(schema: Schema, options?: TableBatchBuilderOptions) {\n    this.schema = schema;\n    this.options = {...DEFAULT_OPTIONS, ...options};\n  }\n\n  limitReached(): boolean {\n    if (Boolean(this.options?.limit) && this.totalLength >= this.options.limit) {\n      return true;\n    }\n    if (Boolean(this.options?._limitMB) && this.totalBytes / 1e6 >= this.options._limitMB) {\n      return true;\n    }\n    return false;\n  }\n\n  /** @deprecated Use addArrayRow or addObjectRow */\n  addRow(row: any[] | {[columnName: string]: any}): void {\n    if (this.limitReached()) {\n      return;\n    }\n    this.totalLength++;\n    this.rowBytes = this.rowBytes || this._estimateRowMB(row);\n    this.totalBytes += this.rowBytes;\n    if (Array.isArray(row)) {\n      this.addArrayRow(row);\n    } else {\n      this.addObjectRow(row);\n    }\n  }\n\n  /** Add one row to the batch */\n  protected addArrayRow(row: any[]) {\n    if (!this.aggregator) {\n      const TableBatchType = this._getTableBatchType();\n      this.aggregator = new TableBatchType(this.schema, this.options);\n    }\n    this.aggregator.addArrayRow(row);\n  }\n\n  /** Add one row to the batch */\n  protected addObjectRow(row: {[columnName: string]: any}): void {\n    if (!this.aggregator) {\n      const TableBatchType = this._getTableBatchType();\n      this.aggregator = new TableBatchType(this.schema, this.options);\n    }\n    this.aggregator.addObjectRow(row);\n  }\n\n  /** Mark an incoming raw memory chunk has completed */\n  chunkComplete(chunk: ArrayBuffer | string): void {\n    if (chunk instanceof ArrayBuffer) {\n      this.bytesUsed += chunk.byteLength;\n    }\n    if (typeof chunk === 'string') {\n      this.bytesUsed += chunk.length;\n    }\n    this.isChunkComplete = true;\n  }\n\n  getFullBatch(options?: GetBatchOptions): TableBatch | null {\n    return this._isFull() ? this._getBatch(options) : null;\n  }\n\n  getFinalBatch(options?: GetBatchOptions): TableBatch | null {\n    return this._getBatch(options);\n  }\n\n  // INTERNAL\n\n  _estimateRowMB(row: any[] | object): number {\n    return Array.isArray(row) ? row.length * 8 : Object.keys(row).length * 8;\n  }\n\n  private _isFull(): boolean {\n    // No batch, not ready\n    if (!this.aggregator || this.aggregator.rowCount() === 0) {\n      return false;\n    }\n\n    // if batchSize === 'auto' we wait for chunk to complete\n    // if batchSize === number, ensure we have enough rows\n    if (this.options.batchSize === 'auto') {\n      if (!this.isChunkComplete) {\n        return false;\n      }\n    } else if (this.options.batchSize > this.aggregator.rowCount()) {\n      return false;\n    }\n\n    // Debounce batches\n    if (this.options.batchDebounceMs > Date.now() - this.lastBatchEmittedMs) {\n      return false;\n    }\n\n    // Emit batch\n    this.isChunkComplete = false;\n    this.lastBatchEmittedMs = Date.now();\n    return true;\n  }\n\n  /**\n   * bytesUsed can be set via chunkComplete or via getBatch*\n   */\n  private _getBatch(options?: GetBatchOptions): TableBatch | null {\n    if (!this.aggregator) {\n      return null;\n    }\n\n    // TODO - this can overly increment bytes used?\n    if (options?.bytesUsed) {\n      this.bytesUsed = options.bytesUsed;\n    }\n    const normalizedBatch = this.aggregator.getBatch() as TableBatch;\n    normalizedBatch.count = this.batchCount;\n    normalizedBatch.bytesUsed = this.bytesUsed;\n    Object.assign(normalizedBatch, options);\n\n    this.batchCount++;\n    this.aggregator = null;\n    return normalizedBatch;\n  }\n\n  private _getTableBatchType(): TableBatchConstructor {\n    switch (this.options.shape) {\n      case 'row-table':\n        return BaseTableBatchAggregator;\n      case 'array-row-table':\n      case 'object-row-table':\n        return RowTableBatchAggregator;\n      case 'columnar-table':\n        return ColumnarTableBatchAggregator;\n      case 'arrow-table':\n        if (!TableBatchBuilder.ArrowBatch) {\n          throw new Error(ERR_MESSAGE);\n        }\n        return TableBatchBuilder.ArrowBatch;\n      default:\n        throw new Error(ERR_MESSAGE);\n    }\n  }\n}\n"],"file":"table-batch-builder.js"}