{"version":3,"sources":["../../../../src/tileset/traversers/tileset-3d-traverser.ts"],"names":["Tileset3DTraverser","a","b","_distanceToCamera","_centerZDepth","tile","frameState","isVisibleAndInRequestVolume","hasChildren","children","length","hasTilesetContent","firstChild","updateTileVisibility","_visible","meetsScreenSpaceErrorEarly","replace","refine","TILE_REFINEMENT","REPLACE","useOptimization","_optimChildrenWithinParent","TILE3D_OPTIMIZATION_HINT","USE_OPTIMIZATION","anyChildrenVisible","parent","ADD","shouldRefine","TilesetTraverser"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAGA;;AACA;;;;;;IAEqBA,kB;;;;;;;;;;;;WACnB,iCAAwBC,CAAxB,EAA2BC,CAA3B,EAA8B;AAE5B,aAAOA,CAAC,CAACC,iBAAF,KAAwB,CAAxB,IAA6BF,CAAC,CAACE,iBAAF,KAAwB,CAArD,GACHD,CAAC,CAACE,aAAF,GAAkBH,CAAC,CAACG,aADjB,GAEHF,CAAC,CAACC,iBAAF,GAAsBF,CAAC,CAACE,iBAF5B;AAGD;;;WAED,8BAAqBE,IAArB,EAA2BC,UAA3B,EAAuC;AACrC,+HAA2BD,IAA3B,EAAiCC,UAAjC;;AAGA,UAAI,CAACD,IAAI,CAACE,2BAAV,EAAuC;AACrC;AACD;;AAED,UAAMC,WAAW,GAAGH,IAAI,CAACI,QAAL,CAAcC,MAAd,GAAuB,CAA3C;;AACA,UAAIL,IAAI,CAACM,iBAAL,IAA0BH,WAA9B,EAA2C;AAIzC,YAAMI,UAAU,GAAGP,IAAI,CAACI,QAAL,CAAc,CAAd,CAAnB;AACA,aAAKI,oBAAL,CAA0BD,UAA1B,EAAsCN,UAAtC;AACAD,QAAAA,IAAI,CAACS,QAAL,GAAgBF,UAAU,CAACE,QAA3B;AACA;AACD;;AAED,UAAI,KAAKC,0BAAL,CAAgCV,IAAhC,EAAsCC,UAAtC,CAAJ,EAAuD;AACrDD,QAAAA,IAAI,CAACS,QAAL,GAAgB,KAAhB;AACA;AACD;;AAED,UAAME,OAAO,GAAGX,IAAI,CAACY,MAAL,KAAgBC,2BAAgBC,OAAhD;AACA,UAAMC,eAAe,GACnBf,IAAI,CAACgB,0BAAL,KAAoCC,oCAAyBC,gBAD/D;;AAEA,UAAIP,OAAO,IAAII,eAAX,IAA8BZ,WAAlC,EAA+C;AAC7C,YAAI,CAAC,KAAKgB,kBAAL,CAAwBnB,IAAxB,EAA8BC,UAA9B,CAAL,EAAgD;AAC9CD,UAAAA,IAAI,CAACS,QAAL,GAAgB,KAAhB;AACA;AACD;AACF;AACF;;;WAED,oCAA2BT,IAA3B,EAAiCC,UAAjC,EAA6C;AAC3C,UAAOmB,MAAP,GAAiBpB,IAAjB,CAAOoB,MAAP;;AACA,UAAI,CAACA,MAAD,IAAWA,MAAM,CAACd,iBAAlB,IAAuCc,MAAM,CAACR,MAAP,KAAkBC,2BAAgBQ,GAA7E,EAAkF;AAChF,eAAO,KAAP;AACD;;AAGD,aAAO,CAAC,KAAKC,YAAL,CAAkBtB,IAAlB,EAAwBC,UAAxB,EAAoC,IAApC,CAAR;AACD;;;EAnD6CsB,yB","sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\nimport {TILE3D_OPTIMIZATION_HINT, TILE_REFINEMENT} from '../../constants';\nimport TilesetTraverser from './tileset-traverser';\n\nexport default class Tileset3DTraverser extends TilesetTraverser {\n  compareDistanceToCamera(a, b) {\n    // Sort by farthest child first since this is going on a stack\n    return b._distanceToCamera === 0 && a._distanceToCamera === 0\n      ? b._centerZDepth - a._centerZDepth\n      : b._distanceToCamera - a._distanceToCamera;\n  }\n\n  updateTileVisibility(tile, frameState) {\n    super.updateTileVisibility(tile, frameState);\n\n    //  Optimization - if none of the tile's children are visible then this tile isn't visible\n    if (!tile.isVisibleAndInRequestVolume) {\n      return;\n    }\n\n    const hasChildren = tile.children.length > 0;\n    if (tile.hasTilesetContent && hasChildren) {\n      // Use the root tile's visibility instead of this tile's visibility.\n      // The root tile may be culled by the children bounds optimization in which\n      // case this tile should also be culled.\n      const firstChild = tile.children[0];\n      this.updateTileVisibility(firstChild, frameState);\n      tile._visible = firstChild._visible;\n      return;\n    }\n\n    if (this.meetsScreenSpaceErrorEarly(tile, frameState)) {\n      tile._visible = false;\n      return;\n    }\n\n    const replace = tile.refine === TILE_REFINEMENT.REPLACE;\n    const useOptimization =\n      tile._optimChildrenWithinParent === TILE3D_OPTIMIZATION_HINT.USE_OPTIMIZATION;\n    if (replace && useOptimization && hasChildren) {\n      if (!this.anyChildrenVisible(tile, frameState)) {\n        tile._visible = false;\n        return;\n      }\n    }\n  }\n\n  meetsScreenSpaceErrorEarly(tile, frameState) {\n    const {parent} = tile;\n    if (!parent || parent.hasTilesetContent || parent.refine !== TILE_REFINEMENT.ADD) {\n      return false;\n    }\n\n    // Use parent's geometric error with child's box to see if the tile already meet the SSE\n    return !this.shouldRefine(tile, frameState, true);\n  }\n}\n"],"file":"tileset-3d-traverser.js"}