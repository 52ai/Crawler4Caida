{"version":3,"sources":["../../../../src/lib/process-utils/child-process-proxy.ts"],"names":["DEFAULT_PROPS","command","arguments","port","autoPort","wait","onSuccess","processProxy","console","log","props","ChildProcessProxy","id","args","Number","portArg","push","String","Promise","resolve","reject","_setTimeout","join","childProcess","ChildProcess","spawn","stdout","on","data","toString","stderr","_clearTimeout","Error","error","code","kill","statusCode","stop","process","exit","message","callback","successTimer","setTimeout","clearTimeout"],"mappings":"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","sourcesContent":["/* eslint-disable no-console */\n// Avoid using named imports for Node builtins to help with \"empty\" resolution\n// for bundlers targeting browser environments. Access imports & types\n// through the `ChildProcess` object (e.g. `ChildProcess.spawn`, `ChildProcess.ChildProcess`).\nimport * as ChildProcess from 'child_process';\nimport {getAvailablePort} from './process-utils';\n\nexport type ChildProcessProxyProps = {\n  command: string;\n  arguments: string[];\n  /** Whether to add a port specified arg */\n  portArg?: string;\n  /** Base port number */\n  port?: number;\n  /** Whether to search for an available port if the base port is occupied */\n  autoPort?: boolean;\n  /** Number of milliseconds to wait until concluding success */\n  /** wait: 0 - infinity */\n  wait?: number;\n  /** Options passed on to Node'.js `spawn` */\n  spawn?: ChildProcess.SpawnOptionsWithoutStdio;\n  /** Callback when the  */\n  onStart?: (proxy: ChildProcessProxy) => void;\n  onSuccess?: (proxy: ChildProcessProxy) => void;\n};\n\nconst DEFAULT_PROPS: ChildProcessProxyProps = {\n  command: '',\n  arguments: [],\n  port: 5000,\n  autoPort: true,\n  wait: 2000,\n  onSuccess: (processProxy) => {\n    console.log(`Started ${processProxy.props.command}`);\n  }\n};\n\n/**\n * Manager for a Node.js child process\n * Prepares arguments, starts, stops and tracks output\n */\nexport default class ChildProcessProxy {\n  id: string;\n  props: ChildProcessProxyProps = {...DEFAULT_PROPS};\n  private childProcess: ChildProcess.ChildProcess | null = null;\n  private port: number = 0;\n  private successTimer?: any; // NodeJS.Timeout;\n\n  // constructor(props?: {id?: string});\n  constructor({id = 'browser-driver'} = {}) {\n    this.id = id;\n  }\n\n  /** Starts a child process with the provided props */\n  async start(props: ChildProcessProxyProps): Promise<object> {\n    props = {...DEFAULT_PROPS, ...props};\n    this.props = props;\n\n    const args = [...props.arguments];\n\n    // If portArg is set, we can look up an available port\n    this.port = Number(props.port);\n    if (props.portArg) {\n      if (props.autoPort) {\n        this.port = await getAvailablePort(props.port);\n      }\n      args.push(props.portArg, String(this.port));\n    }\n\n    return await new Promise((resolve, reject) => {\n      try {\n        this._setTimeout(() => {\n          if (props.onSuccess) {\n            props.onSuccess(this);\n          }\n          resolve({});\n        });\n\n        console.log(`Spawning ${props.command} ${props.arguments.join(' ')}`);\n        const childProcess = ChildProcess.spawn(props.command, args, props.spawn);\n        this.childProcess = childProcess;\n\n        childProcess.stdout.on('data', (data) => {\n          console.log(data.toString());\n        });\n        // TODO - add option regarding whether stderr should be treated as data\n        childProcess.stderr.on('data', (data) => {\n          console.log(`Child process wrote to stderr: \"${data}\".`);\n          this._clearTimeout();\n          reject(new Error(data));\n        });\n        childProcess.on('error', (error) => {\n          console.log(`Child process errored with ${error}`);\n          this._clearTimeout();\n          reject(error);\n        });\n        childProcess.on('close', (code) => {\n          console.log(`Child process exited with ${code}`);\n          this.childProcess = null;\n          this._clearTimeout();\n          resolve({});\n        });\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  /** Stops a running child process */\n  async stop(): Promise<void> {\n    if (this.childProcess) {\n      this.childProcess.kill();\n      this.childProcess = null;\n    }\n  }\n\n  /** Exits this process */\n  async exit(statusCode: number = 0): Promise<void> {\n    try {\n      await this.stop();\n      // eslint-disable-next-line no-process-exit\n      process.exit(statusCode);\n    } catch (error) {\n      console.error((error as Error).message || error);\n      // eslint-disable-next-line no-process-exit\n      process.exit(1);\n    }\n  }\n\n  _setTimeout(callback: (...args: any[]) => void) {\n    if (Number(this.props.wait) > 0) {\n      this.successTimer = setTimeout(callback, this.props.wait);\n    }\n  }\n\n  _clearTimeout() {\n    if (this.successTimer) {\n      clearTimeout(this.successTimer);\n    }\n  }\n}\n"],"file":"child-process-proxy.js"}