{"version":3,"sources":["../../../../src/lib/worker-farm/worker-thread.ts"],"names":["NOOP","WorkerThread","props","name","source","url","onMessage","onError","error","console","log","worker","isBrowser","_createBrowserWorker","_createNodeWorker","terminate","terminated","Boolean","data","transferList","postMessage","event","message","lineno","colno","Error","_loadableURL","Worker","onmessage","onerror","_getErrorFromErrorEvent","onmessageerror","absolute","includes","startsWith","NodeWorker","eval","on","code"],"mappings":";;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AAEA,IAAMA,IAAI,GAAG,SAAPA,IAAO,GAAM,CAAE,CAArB;;IAWqBC,Y;AAmBnB,wBAAYC,KAAZ,EAAsC;AAAA;AAAA;AAAA;AAAA;AAAA,sDAfhB,KAegB;AAAA;AAAA;AAAA;AAAA,wDAVP,EAUO;AACpC,QAAOC,IAAP,GAA4BD,KAA5B,CAAOC,IAAP;AAAA,QAAaC,MAAb,GAA4BF,KAA5B,CAAaE,MAAb;AAAA,QAAqBC,GAArB,GAA4BH,KAA5B,CAAqBG,GAArB;AACA,wBAAOD,MAAM,IAAIC,GAAjB;AACA,SAAKF,IAAL,GAAYA,IAAZ;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,GAAL,GAAWA,GAAX;AACA,SAAKC,SAAL,GAAiBN,IAAjB;;AACA,SAAKO,OAAL,GAAe,UAACC,KAAD;AAAA,aAAWC,OAAO,CAACC,GAAR,CAAYF,KAAZ,CAAX;AAAA,KAAf;;AAEA,SAAKG,MAAL,GAAcC,qBAAY,KAAKC,oBAAL,EAAZ,GAA0C,KAAKC,iBAAL,EAAxD;AACD;;;;WAMD,mBAAgB;AACd,WAAKR,SAAL,GAAiBN,IAAjB;AACA,WAAKO,OAAL,GAAeP,IAAf;AACA,WAAKW,MAAL,CAAYI,SAAZ;AACA,WAAKC,UAAL,GAAkB,IAAlB;AACD;;;SAED,eAAgB;AACd,aAAOC,OAAO,CAAC,KAAKX,SAAN,CAAd;AACD;;;WAOD,qBAAYY,IAAZ,EAAuBC,YAAvB,EAAmD;AACjDA,MAAAA,YAAY,GAAGA,YAAY,IAAI,sCAAgBD,IAAhB,CAA/B;AAEA,WAAKP,MAAL,CAAYS,WAAZ,CAAwBF,IAAxB,EAA8BC,YAA9B;AACD;;;WAQD,iCAAwBE,KAAxB,EAAkD;AAIhD,UAAIC,OAAO,GAAG,iBAAd;AACAA,MAAAA,OAAO,qBAAc,KAAKnB,IAAnB,mBAAgC,KAAKE,GAArC,OAAP;;AACA,UAAIgB,KAAK,CAACC,OAAV,EAAmB;AACjBA,QAAAA,OAAO,cAAOD,KAAK,CAACC,OAAb,SAAP;AACD;;AAGD,UAAID,KAAK,CAACE,MAAV,EAAkB;AAChBD,QAAAA,OAAO,eAAQD,KAAK,CAACE,MAAd,cAAwBF,KAAK,CAACG,KAA9B,CAAP;AACD;;AACD,aAAO,IAAIC,KAAJ,CAAUH,OAAV,CAAP;AACD;;;WAKD,gCAA+B;AAAA;;AAC7B,WAAKI,YAAL,GAAoB,gDAAqB;AAACtB,QAAAA,MAAM,EAAE,KAAKA,MAAd;AAAsBC,QAAAA,GAAG,EAAE,KAAKA;AAAhC,OAArB,CAApB;AACA,UAAMM,MAAM,GAAG,IAAIgB,MAAJ,CAAW,KAAKD,YAAhB,EAA8B;AAACvB,QAAAA,IAAI,EAAE,KAAKA;AAAZ,OAA9B,CAAf;;AAEAQ,MAAAA,MAAM,CAACiB,SAAP,GAAmB,UAACP,KAAD,EAAW;AAC5B,YAAI,CAACA,KAAK,CAACH,IAAX,EAAiB;AACf,UAAA,KAAI,CAACX,OAAL,CAAa,IAAIkB,KAAJ,CAAU,kBAAV,CAAb;AACD,SAFD,MAEO;AACL,UAAA,KAAI,CAACnB,SAAL,CAAee,KAAK,CAACH,IAArB;AACD;AACF,OAND;;AAQAP,MAAAA,MAAM,CAACkB,OAAP,GAAiB,UAACrB,KAAD,EAA6B;AAC5C,QAAA,KAAI,CAACD,OAAL,CAAa,KAAI,CAACuB,uBAAL,CAA6BtB,KAA7B,CAAb;;AACA,QAAA,KAAI,CAACQ,UAAL,GAAkB,IAAlB;AACD,OAHD;;AAKAL,MAAAA,MAAM,CAACoB,cAAP,GAAwB,UAACV,KAAD;AAAA,eAAWZ,OAAO,CAACD,KAAR,CAAca,KAAd,CAAX;AAAA,OAAxB;;AAEA,aAAOV,MAAP;AACD;;;WAMD,6BAAgC;AAAA;;AAC9B,UAAIA,MAAJ;;AACA,UAAI,KAAKN,GAAT,EAAc;AAEZ,YAAM2B,QAAQ,GAAG,KAAK3B,GAAL,CAAS4B,QAAT,CAAkB,IAAlB,KAA2B,KAAK5B,GAAL,CAAS6B,UAAT,CAAoB,GAApB,CAA5C;AACA,YAAM7B,GAAG,GAAG2B,QAAQ,GAAG,KAAK3B,GAAR,eAAmB,KAAKA,GAAxB,CAApB;AAEAM,QAAAA,MAAM,GAAG,IAAIwB,sBAAJ,CAAe9B,GAAf,EAAoB;AAAC+B,UAAAA,IAAI,EAAE;AAAP,SAApB,CAAT;AACD,OAND,MAMO,IAAI,KAAKhC,MAAT,EAAiB;AACtBO,QAAAA,MAAM,GAAG,IAAIwB,sBAAJ,CAAe,KAAK/B,MAApB,EAA4B;AAACgC,UAAAA,IAAI,EAAE;AAAP,SAA5B,CAAT;AACD,OAFM,MAEA;AACL,cAAM,IAAIX,KAAJ,CAAU,WAAV,CAAN;AACD;;AACDd,MAAAA,MAAM,CAAC0B,EAAP,CAAU,SAAV,EAAqB,UAACnB,IAAD,EAAU;AAE7B,QAAA,MAAI,CAACZ,SAAL,CAAeY,IAAf;AACD,OAHD;AAIAP,MAAAA,MAAM,CAAC0B,EAAP,CAAU,OAAV,EAAmB,UAAC7B,KAAD,EAAW;AAE5B,QAAA,MAAI,CAACD,OAAL,CAAaC,KAAb;AACD,OAHD;AAIAG,MAAAA,MAAM,CAAC0B,EAAP,CAAU,MAAV,EAAkB,UAACC,IAAD,EAAU,CAE3B,CAFD;AAGA,aAAO3B,MAAP;AACD;;;WA1HD,uBAA8B;AAC5B,aACG,OAAOgB,MAAP,KAAkB,WAAlB,IAAiCf,kBAAlC,IACC,OAAOuB,sBAAP,KAAsB,WAAtB,IAAqC,CAACvB,kBAFzC;AAID","sourcesContent":["import {Worker as NodeWorker} from '../node/worker_threads';\nimport {isBrowser} from '../env-utils/globals';\nimport {assert} from '../env-utils/assert';\nimport {getLoadableWorkerURL} from '../worker-utils/get-loadable-worker-url';\nimport {getTransferList} from '../worker-utils/get-transfer-list';\n\nconst NOOP = () => {};\n\nexport type WorkerThreadProps = {\n  name: string;\n  source?: string;\n  url?: string;\n};\n\n/**\n * Represents one worker thread\n */\nexport default class WorkerThread {\n  readonly name: string;\n  readonly source: string | undefined;\n  readonly url: string | undefined;\n  terminated: boolean = false;\n  worker: Worker | NodeWorker;\n  onMessage: (message: any) => void;\n  onError: (error: Error) => void;\n\n  private _loadableURL: string = '';\n\n  /** Checks if workers are supported on this platform */\n  static isSupported(): boolean {\n    return (\n      (typeof Worker !== 'undefined' && isBrowser) ||\n      (typeof NodeWorker !== 'undefined' && !isBrowser)\n    );\n  }\n\n  constructor(props: WorkerThreadProps) {\n    const {name, source, url} = props;\n    assert(source || url); // Either source or url must be defined\n    this.name = name;\n    this.source = source;\n    this.url = url;\n    this.onMessage = NOOP;\n    this.onError = (error) => console.log(error); // eslint-disable-line\n\n    this.worker = isBrowser ? this._createBrowserWorker() : this._createNodeWorker();\n  }\n\n  /**\n   * Terminate this worker thread\n   * @note Can free up significant memory\n   */\n  destroy(): void {\n    this.onMessage = NOOP;\n    this.onError = NOOP;\n    this.worker.terminate(); // eslint-disable-line @typescript-eslint/no-floating-promises\n    this.terminated = true;\n  }\n\n  get isRunning() {\n    return Boolean(this.onMessage);\n  }\n\n  /**\n   * Send a message to this worker thread\n   * @param data any data structure, ideally consisting mostly of transferrable objects\n   * @param transferList If not supplied, calculated automatically by traversing data\n   */\n  postMessage(data: any, transferList?: any[]): void {\n    transferList = transferList || getTransferList(data);\n    // @ts-ignore\n    this.worker.postMessage(data, transferList);\n  }\n\n  // PRIVATE\n\n  /**\n   * Generate a standard Error from an ErrorEvent\n   * @param event\n   */\n  _getErrorFromErrorEvent(event: ErrorEvent): Error {\n    // Note Error object does not have the expected fields if loading failed completely\n    // https://developer.mozilla.org/en-US/docs/Web/API/Worker#Event_handlers\n    // https://developer.mozilla.org/en-US/docs/Web/API/ErrorEvent\n    let message = 'Failed to load ';\n    message += `worker ${this.name} from ${this.url}. `;\n    if (event.message) {\n      message += `${event.message} in `;\n    }\n    // const hasFilename = event.filename && !event.filename.startsWith('blob:');\n    // message += hasFilename ? event.filename : this.source.slice(0, 100);\n    if (event.lineno) {\n      message += `:${event.lineno}:${event.colno}`;\n    }\n    return new Error(message);\n  }\n\n  /**\n   * Creates a worker thread on the browser\n   */\n  _createBrowserWorker(): Worker {\n    this._loadableURL = getLoadableWorkerURL({source: this.source, url: this.url});\n    const worker = new Worker(this._loadableURL, {name: this.name});\n\n    worker.onmessage = (event) => {\n      if (!event.data) {\n        this.onError(new Error('No data received'));\n      } else {\n        this.onMessage(event.data);\n      }\n    };\n    // This callback represents an uncaught exception in the worker thread\n    worker.onerror = (error: ErrorEvent): void => {\n      this.onError(this._getErrorFromErrorEvent(error));\n      this.terminated = true;\n    };\n    // TODO - not clear when this would be called, for now just log in case it happens\n    worker.onmessageerror = (event) => console.error(event); // eslint-disable-line\n\n    return worker;\n  }\n\n  /**\n   * Creates a worker thread in node.js\n   * @todo https://nodejs.org/api/async_hooks.html#async-resource-worker-pool\n   */\n  _createNodeWorker(): NodeWorker {\n    let worker: NodeWorker;\n    if (this.url) {\n      // Make sure relative URLs start with './'\n      const absolute = this.url.includes(':/') || this.url.startsWith('/');\n      const url = absolute ? this.url : `./${this.url}`;\n      // console.log('Starting work from', url);\n      worker = new NodeWorker(url, {eval: false});\n    } else if (this.source) {\n      worker = new NodeWorker(this.source, {eval: true});\n    } else {\n      throw new Error('no worker');\n    }\n    worker.on('message', (data) => {\n      // console.error('message', data);\n      this.onMessage(data);\n    });\n    worker.on('error', (error) => {\n      // console.error('error', error);\n      this.onError(error);\n    });\n    worker.on('exit', (code) => {\n      // console.error('exit', code);\n    });\n    return worker;\n  }\n}\n"],"file":"worker-thread.js"}