{"version":3,"file":"assemble-shaders.js","names":["INJECT_SHADER_DECLARATIONS","DECLARATION_INJECT_MARKER","SHADER_TYPE","VERTEX_SHADER","FRAGMENT_SHADER","FRAGMENT_SHADER_PROLOGUE","assembleShaders","gl","opts","vs","fs","modules","resolveModules","assembleShader","Object","assign","source","type","getUniforms","assembleGetUniforms","id","defines","hookFunctions","inject","transpileToGLSL100","prologue","log","assert","isVertex","sourceLines","split","glslVersion","versionLine","coreSource","indexOf","slice","join","allDefines","forEach","module","getDefines","assembledSource","getShaderName","getShaderType","getPlatformShaderDefines","getVersionDefines","getApplicationDefines","hookFunctionMap","normalizeHookFunctions","hookInjections","declInjections","mainInjections","key","injection","order","match","hash","name","checkDeprecations","moduleSource","getModuleSource","injections","injectionType","push","injectShader","getHookFunctions","transpileShader","uniforms","moduleUniforms","toUpperCase","injectShaderName","count","sourceText","define","value","Number","isFinite","result","hookName","hookFunction","signature","header","sort","a","b","footer","hook","trim","stage","replace"],"sources":["../../../src/lib/assemble-shaders.js"],"sourcesContent":["import {VERTEX_SHADER, FRAGMENT_SHADER} from './constants';\nimport {resolveModules} from './resolve-modules';\nimport {getPlatformShaderDefines, getVersionDefines} from './platform-defines';\nimport injectShader, {DECLARATION_INJECT_MARKER} from './inject-shader';\nimport transpileShader from './transpile-shader';\nimport {assert} from '../utils';\n\nconst INJECT_SHADER_DECLARATIONS = `\\n\\n${DECLARATION_INJECT_MARKER}\\n\\n`;\n\nconst SHADER_TYPE = {\n  [VERTEX_SHADER]: 'vertex',\n  [FRAGMENT_SHADER]: 'fragment'\n};\n\n// Precision prologue to inject before functions are injected in shader\n// TODO - extract any existing prologue in the fragment source and move it up...\nconst FRAGMENT_SHADER_PROLOGUE = `\\\nprecision highp float;\n\n`;\n\n// Inject a list of modules\nexport function assembleShaders(gl, opts) {\n  const {vs, fs} = opts;\n  const modules = resolveModules(opts.modules || []);\n  return {\n    gl,\n    vs: assembleShader(gl, Object.assign({}, opts, {source: vs, type: VERTEX_SHADER, modules})),\n    fs: assembleShader(gl, Object.assign({}, opts, {source: fs, type: FRAGMENT_SHADER, modules})),\n    getUniforms: assembleGetUniforms(modules)\n  };\n}\n\n// Pulls together complete source code for either a vertex or a fragment shader\n// adding prologues, requested module chunks, and any final injections.\nfunction assembleShader(\n  gl,\n  {\n    id,\n    source,\n    type,\n    modules,\n    defines = {},\n    hookFunctions = [],\n    inject = {},\n    transpileToGLSL100 = false,\n    prologue = true,\n    log\n  }\n) {\n  assert(typeof source === 'string', 'shader source must be a string');\n\n  const isVertex = type === VERTEX_SHADER;\n\n  const sourceLines = source.split('\\n');\n  let glslVersion = 100;\n  let versionLine = '';\n  let coreSource = source;\n  // Extract any version directive string from source.\n  // TODO : keep all pre-processor statements at the begining of the shader.\n  if (sourceLines[0].indexOf('#version ') === 0) {\n    glslVersion = 300; // TODO - regexp that matches actual version number\n    versionLine = sourceLines[0];\n    coreSource = sourceLines.slice(1).join('\\n');\n  } else {\n    versionLine = `#version ${glslVersion}`;\n  }\n\n  // Combine Module and Application Defines\n  const allDefines = {};\n  modules.forEach(module => {\n    Object.assign(allDefines, module.getDefines());\n  });\n  Object.assign(allDefines, defines);\n\n  // Add platform defines (use these to work around platform-specific bugs and limitations)\n  // Add common defines (GLSL version compatibility, feature detection)\n  // Add precision declaration for fragment shaders\n  let assembledSource = prologue\n    ? `\\\n${versionLine}\n${getShaderName({id, source, type})}\n${getShaderType({type})}\n${getPlatformShaderDefines(gl)}\n${getVersionDefines(gl, glslVersion, !isVertex)}\n${getApplicationDefines(allDefines)}\n${isVertex ? '' : FRAGMENT_SHADER_PROLOGUE}\n`\n    : `${versionLine}\n`;\n\n  const hookFunctionMap = normalizeHookFunctions(hookFunctions);\n\n  // Add source of dependent modules in resolved order\n  const hookInjections = {};\n  const declInjections = {};\n  const mainInjections = {};\n\n  for (const key in inject) {\n    const injection =\n      typeof inject[key] === 'string' ? {injection: inject[key], order: 0} : inject[key];\n    const match = key.match(/^(v|f)s:(#)?([\\w-]+)$/);\n    if (match) {\n      const hash = match[2];\n      const name = match[3];\n      if (hash) {\n        if (name === 'decl') {\n          declInjections[key] = [injection];\n        } else {\n          mainInjections[key] = [injection];\n        }\n      } else {\n        hookInjections[key] = [injection];\n      }\n    } else {\n      // Regex injection\n      mainInjections[key] = [injection];\n    }\n  }\n\n  for (const module of modules) {\n    if (log) {\n      module.checkDeprecations(coreSource, log);\n    }\n    const moduleSource = module.getModuleSource(type, glslVersion);\n    // Add the module source, and a #define that declares it presence\n    assembledSource += moduleSource;\n\n    const injections = module.injections[type];\n    for (const key in injections) {\n      const match = key.match(/^(v|f)s:#([\\w-]+)$/);\n      if (match) {\n        const name = match[2];\n        const injectionType = name === 'decl' ? declInjections : mainInjections;\n        injectionType[key] = injectionType[key] || [];\n        injectionType[key].push(injections[key]);\n      } else {\n        hookInjections[key] = hookInjections[key] || [];\n        hookInjections[key].push(injections[key]);\n      }\n    }\n  }\n\n  // For injectShader\n  assembledSource += INJECT_SHADER_DECLARATIONS;\n\n  assembledSource = injectShader(assembledSource, type, declInjections);\n\n  assembledSource += getHookFunctions(hookFunctionMap[type], hookInjections);\n\n  // Add the version directive and actual source of this shader\n  assembledSource += coreSource;\n\n  // Apply any requested shader injections\n  assembledSource = injectShader(assembledSource, type, mainInjections);\n\n  assembledSource = transpileShader(\n    assembledSource,\n    transpileToGLSL100 ? 100 : glslVersion,\n    isVertex\n  );\n\n  return assembledSource;\n}\n\n// Returns a combined `getUniforms` covering the options for all the modules,\n// the created function will pass on options to the inidividual `getUniforms`\n// function of each shader module and combine the results into one object that\n// can be passed to setUniforms.\nfunction assembleGetUniforms(modules) {\n  return function getUniforms(opts) {\n    const uniforms = {};\n    for (const module of modules) {\n      // `modules` is already sorted by dependency level. This guarantees that\n      // modules have access to the uniforms that are generated by their dependencies.\n      const moduleUniforms = module.getUniforms(opts, uniforms);\n      Object.assign(uniforms, moduleUniforms);\n    }\n    return uniforms;\n  };\n}\n\nfunction getShaderType({type}) {\n  return `\n#define SHADER_TYPE_${SHADER_TYPE[type].toUpperCase()}\n`;\n}\n\n// Generate \"glslify-compatible\" SHADER_NAME defines\n// These are understood by the GLSL error parsing function\n// If id is provided and no SHADER_NAME constant is present in source, create one\nfunction getShaderName({id, source, type}) {\n  const injectShaderName = id && typeof id === 'string' && source.indexOf('SHADER_NAME') === -1;\n  return injectShaderName\n    ? `\n#define SHADER_NAME ${id}_${SHADER_TYPE[type]}\n\n`\n    : '';\n}\n\n// Generates application defines from an object\nfunction getApplicationDefines(defines = {}) {\n  let count = 0;\n  let sourceText = '';\n  for (const define in defines) {\n    if (count === 0) {\n      sourceText += '\\n// APPLICATION DEFINES\\n';\n    }\n    count++;\n\n    const value = defines[define];\n    if (value || Number.isFinite(value)) {\n      sourceText += `#define ${define.toUpperCase()} ${defines[define]}\\n`;\n    }\n  }\n  if (count === 0) {\n    sourceText += '\\n';\n  }\n  return sourceText;\n}\n\nfunction getHookFunctions(hookFunctions, hookInjections) {\n  let result = '';\n  for (const hookName in hookFunctions) {\n    const hookFunction = hookFunctions[hookName];\n    result += `void ${hookFunction.signature} {\\n`;\n    if (hookFunction.header) {\n      result += `  ${hookFunction.header}`;\n    }\n    if (hookInjections[hookName]) {\n      const injections = hookInjections[hookName];\n      injections.sort((a, b) => a.order - b.order);\n      for (const injection of injections) {\n        result += `  ${injection.injection}\\n`;\n      }\n    }\n    if (hookFunction.footer) {\n      result += `  ${hookFunction.footer}`;\n    }\n    result += '}\\n';\n  }\n\n  return result;\n}\n\nfunction normalizeHookFunctions(hookFunctions) {\n  const result = {\n    vs: {},\n    fs: {}\n  };\n\n  hookFunctions.forEach(hook => {\n    let opts;\n    if (typeof hook !== 'string') {\n      opts = hook;\n      hook = opts.hook;\n    } else {\n      opts = {};\n    }\n    hook = hook.trim();\n    const [stage, signature] = hook.split(':');\n    const name = hook.replace(/\\(.+/, '');\n    result[stage][name] = Object.assign(opts, {signature});\n  });\n\n  return result;\n}\n"],"mappings":";;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;AAEA,IAAMA,0BAA0B,iBAAUC,uCAAV,SAAhC;AAEA,IAAMC,WAAW,mEACdC,wBADc,EACE,QADF,+CAEdC,0BAFc,EAEI,UAFJ,gBAAjB;AAOA,IAAMC,wBAAwB,+BAA9B;;AAMO,SAASC,eAAT,CAAyBC,EAAzB,EAA6BC,IAA7B,EAAmC;EACxC,IAAOC,EAAP,GAAiBD,IAAjB,CAAOC,EAAP;EAAA,IAAWC,EAAX,GAAiBF,IAAjB,CAAWE,EAAX;EACA,IAAMC,OAAO,GAAG,IAAAC,8BAAA,EAAeJ,IAAI,CAACG,OAAL,IAAgB,EAA/B,CAAhB;EACA,OAAO;IACLJ,EAAE,EAAFA,EADK;IAELE,EAAE,EAAEI,cAAc,CAACN,EAAD,EAAKO,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBP,IAAlB,EAAwB;MAACQ,MAAM,EAAEP,EAAT;MAAaQ,IAAI,EAAEd,wBAAnB;MAAkCQ,OAAO,EAAPA;IAAlC,CAAxB,CAAL,CAFb;IAGLD,EAAE,EAAEG,cAAc,CAACN,EAAD,EAAKO,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBP,IAAlB,EAAwB;MAACQ,MAAM,EAAEN,EAAT;MAAaO,IAAI,EAAEb,0BAAnB;MAAoCO,OAAO,EAAPA;IAApC,CAAxB,CAAL,CAHb;IAILO,WAAW,EAAEC,mBAAmB,CAACR,OAAD;EAJ3B,CAAP;AAMD;;AAID,SAASE,cAAT,CACEN,EADF,QAcE;EAAA,IAXEa,EAWF,QAXEA,EAWF;EAAA,IAVEJ,MAUF,QAVEA,MAUF;EAAA,IATEC,IASF,QATEA,IASF;EAAA,IAREN,OAQF,QAREA,OAQF;EAAA,wBAPEU,OAOF;EAAA,IAPEA,OAOF,6BAPY,EAOZ;EAAA,8BANEC,aAMF;EAAA,IANEA,aAMF,mCANkB,EAMlB;EAAA,uBALEC,MAKF;EAAA,IALEA,MAKF,4BALW,EAKX;EAAA,gCAJEC,kBAIF;EAAA,IAJEA,kBAIF,qCAJuB,KAIvB;EAAA,yBAHEC,QAGF;EAAA,IAHEA,QAGF,8BAHa,IAGb;EAAA,IAFEC,GAEF,QAFEA,GAEF;EACA,IAAAC,aAAA,EAAO,OAAOX,MAAP,KAAkB,QAAzB,EAAmC,gCAAnC;EAEA,IAAMY,QAAQ,GAAGX,IAAI,KAAKd,wBAA1B;EAEA,IAAM0B,WAAW,GAAGb,MAAM,CAACc,KAAP,CAAa,IAAb,CAApB;EACA,IAAIC,WAAW,GAAG,GAAlB;EACA,IAAIC,WAAW,GAAG,EAAlB;EACA,IAAIC,UAAU,GAAGjB,MAAjB;;EAGA,IAAIa,WAAW,CAAC,CAAD,CAAX,CAAeK,OAAf,CAAuB,WAAvB,MAAwC,CAA5C,EAA+C;IAC7CH,WAAW,GAAG,GAAd;IACAC,WAAW,GAAGH,WAAW,CAAC,CAAD,CAAzB;IACAI,UAAU,GAAGJ,WAAW,CAACM,KAAZ,CAAkB,CAAlB,EAAqBC,IAArB,CAA0B,IAA1B,CAAb;EACD,CAJD,MAIO;IACLJ,WAAW,sBAAeD,WAAf,CAAX;EACD;;EAGD,IAAMM,UAAU,GAAG,EAAnB;EACA1B,OAAO,CAAC2B,OAAR,CAAgB,UAAAC,MAAM,EAAI;IACxBzB,MAAM,CAACC,MAAP,CAAcsB,UAAd,EAA0BE,MAAM,CAACC,UAAP,EAA1B;EACD,CAFD;EAGA1B,MAAM,CAACC,MAAP,CAAcsB,UAAd,EAA0BhB,OAA1B;EAKA,IAAIoB,eAAe,GAAGhB,QAAQ,aAE9BO,WAF8B,eAG9BU,aAAa,CAAC;IAACtB,EAAE,EAAFA,EAAD;IAAKJ,MAAM,EAANA,MAAL;IAAaC,IAAI,EAAJA;EAAb,CAAD,CAHiB,eAI9B0B,aAAa,CAAC;IAAC1B,IAAI,EAAJA;EAAD,CAAD,CAJiB,eAK9B,IAAA2B,yCAAA,EAAyBrC,EAAzB,CAL8B,eAM9B,IAAAsC,kCAAA,EAAkBtC,EAAlB,EAAsBwB,WAAtB,EAAmC,CAACH,QAApC,CAN8B,eAO9BkB,qBAAqB,CAACT,UAAD,CAPS,eAQ9BT,QAAQ,GAAG,EAAH,GAAQvB,wBARc,oBAUvB2B,WAVuB,OAA9B;EAaA,IAAMe,eAAe,GAAGC,sBAAsB,CAAC1B,aAAD,CAA9C;EAGA,IAAM2B,cAAc,GAAG,EAAvB;EACA,IAAMC,cAAc,GAAG,EAAvB;EACA,IAAMC,cAAc,GAAG,EAAvB;;EAEA,KAAK,IAAMC,GAAX,IAAkB7B,MAAlB,EAA0B;IACxB,IAAM8B,SAAS,GACb,OAAO9B,MAAM,CAAC6B,GAAD,CAAb,KAAuB,QAAvB,GAAkC;MAACC,SAAS,EAAE9B,MAAM,CAAC6B,GAAD,CAAlB;MAAyBE,KAAK,EAAE;IAAhC,CAAlC,GAAuE/B,MAAM,CAAC6B,GAAD,CAD/E;IAEA,IAAMG,KAAK,GAAGH,GAAG,CAACG,KAAJ,CAAU,uBAAV,CAAd;;IACA,IAAIA,KAAJ,EAAW;MACT,IAAMC,IAAI,GAAGD,KAAK,CAAC,CAAD,CAAlB;MACA,IAAME,IAAI,GAAGF,KAAK,CAAC,CAAD,CAAlB;;MACA,IAAIC,IAAJ,EAAU;QACR,IAAIC,IAAI,KAAK,MAAb,EAAqB;UACnBP,cAAc,CAACE,GAAD,CAAd,GAAsB,CAACC,SAAD,CAAtB;QACD,CAFD,MAEO;UACLF,cAAc,CAACC,GAAD,CAAd,GAAsB,CAACC,SAAD,CAAtB;QACD;MACF,CAND,MAMO;QACLJ,cAAc,CAACG,GAAD,CAAd,GAAsB,CAACC,SAAD,CAAtB;MACD;IACF,CAZD,MAYO;MAELF,cAAc,CAACC,GAAD,CAAd,GAAsB,CAACC,SAAD,CAAtB;IACD;EACF;;EArED,2CAuEqB1C,OAvErB;EAAA;;EAAA;IAuEA,oDAA8B;MAAA,IAAnB4B,MAAmB;;MAC5B,IAAIb,GAAJ,EAAS;QACPa,MAAM,CAACmB,iBAAP,CAAyBzB,UAAzB,EAAqCP,GAArC;MACD;;MACD,IAAMiC,YAAY,GAAGpB,MAAM,CAACqB,eAAP,CAAuB3C,IAAvB,EAA6Bc,WAA7B,CAArB;MAEAU,eAAe,IAAIkB,YAAnB;MAEA,IAAME,UAAU,GAAGtB,MAAM,CAACsB,UAAP,CAAkB5C,IAAlB,CAAnB;;MACA,KAAK,IAAMmC,IAAX,IAAkBS,UAAlB,EAA8B;QAC5B,IAAMN,MAAK,GAAGH,IAAG,CAACG,KAAJ,CAAU,oBAAV,CAAd;;QACA,IAAIA,MAAJ,EAAW;UACT,IAAME,KAAI,GAAGF,MAAK,CAAC,CAAD,CAAlB;UACA,IAAMO,aAAa,GAAGL,KAAI,KAAK,MAAT,GAAkBP,cAAlB,GAAmCC,cAAzD;UACAW,aAAa,CAACV,IAAD,CAAb,GAAqBU,aAAa,CAACV,IAAD,CAAb,IAAsB,EAA3C;;UACAU,aAAa,CAACV,IAAD,CAAb,CAAmBW,IAAnB,CAAwBF,UAAU,CAACT,IAAD,CAAlC;QACD,CALD,MAKO;UACLH,cAAc,CAACG,IAAD,CAAd,GAAsBH,cAAc,CAACG,IAAD,CAAd,IAAuB,EAA7C;;UACAH,cAAc,CAACG,IAAD,CAAd,CAAoBW,IAApB,CAAyBF,UAAU,CAACT,IAAD,CAAnC;QACD;MACF;IACF;EA5FD;IAAA;EAAA;IAAA;EAAA;;EA+FAX,eAAe,IAAIzC,0BAAnB;EAEAyC,eAAe,GAAG,IAAAuB,qBAAA,EAAavB,eAAb,EAA8BxB,IAA9B,EAAoCiC,cAApC,CAAlB;EAEAT,eAAe,IAAIwB,gBAAgB,CAAClB,eAAe,CAAC9B,IAAD,CAAhB,EAAwBgC,cAAxB,CAAnC;EAGAR,eAAe,IAAIR,UAAnB;EAGAQ,eAAe,GAAG,IAAAuB,qBAAA,EAAavB,eAAb,EAA8BxB,IAA9B,EAAoCkC,cAApC,CAAlB;EAEAV,eAAe,GAAG,IAAAyB,wBAAA,EAChBzB,eADgB,EAEhBjB,kBAAkB,GAAG,GAAH,GAASO,WAFX,EAGhBH,QAHgB,CAAlB;EAMA,OAAOa,eAAP;AACD;;AAMD,SAAStB,mBAAT,CAA6BR,OAA7B,EAAsC;EACpC,OAAO,SAASO,WAAT,CAAqBV,IAArB,EAA2B;IAChC,IAAM2D,QAAQ,GAAG,EAAjB;;IADgC,4CAEXxD,OAFW;IAAA;;IAAA;MAEhC,uDAA8B;QAAA,IAAnB4B,MAAmB;QAG5B,IAAM6B,cAAc,GAAG7B,MAAM,CAACrB,WAAP,CAAmBV,IAAnB,EAAyB2D,QAAzB,CAAvB;QACArD,MAAM,CAACC,MAAP,CAAcoD,QAAd,EAAwBC,cAAxB;MACD;IAP+B;MAAA;IAAA;MAAA;IAAA;;IAQhC,OAAOD,QAAP;EACD,CATD;AAUD;;AAED,SAASxB,aAAT,QAA+B;EAAA,IAAP1B,IAAO,SAAPA,IAAO;EAC7B,uCACoBf,WAAW,CAACe,IAAD,CAAX,CAAkBoD,WAAlB,EADpB;AAGD;;AAKD,SAAS3B,aAAT,QAA2C;EAAA,IAAnBtB,EAAmB,SAAnBA,EAAmB;EAAA,IAAfJ,MAAe,SAAfA,MAAe;EAAA,IAAPC,IAAO,SAAPA,IAAO;EACzC,IAAMqD,gBAAgB,GAAGlD,EAAE,IAAI,OAAOA,EAAP,KAAc,QAApB,IAAgCJ,MAAM,CAACkB,OAAP,CAAe,aAAf,MAAkC,CAAC,CAA5F;EACA,OAAOoC,gBAAgB,mCAEHlD,EAFG,cAEGlB,WAAW,CAACe,IAAD,CAFd,YAKnB,EALJ;AAMD;;AAGD,SAAS6B,qBAAT,GAA6C;EAAA,IAAdzB,OAAc,uEAAJ,EAAI;EAC3C,IAAIkD,KAAK,GAAG,CAAZ;EACA,IAAIC,UAAU,GAAG,EAAjB;;EACA,KAAK,IAAMC,MAAX,IAAqBpD,OAArB,EAA8B;IAC5B,IAAIkD,KAAK,KAAK,CAAd,EAAiB;MACfC,UAAU,IAAI,4BAAd;IACD;;IACDD,KAAK;IAEL,IAAMG,KAAK,GAAGrD,OAAO,CAACoD,MAAD,CAArB;;IACA,IAAIC,KAAK,IAAIC,MAAM,CAACC,QAAP,CAAgBF,KAAhB,CAAb,EAAqC;MACnCF,UAAU,sBAAeC,MAAM,CAACJ,WAAP,EAAf,cAAuChD,OAAO,CAACoD,MAAD,CAA9C,OAAV;IACD;EACF;;EACD,IAAIF,KAAK,KAAK,CAAd,EAAiB;IACfC,UAAU,IAAI,IAAd;EACD;;EACD,OAAOA,UAAP;AACD;;AAED,SAASP,gBAAT,CAA0B3C,aAA1B,EAAyC2B,cAAzC,EAAyD;EACvD,IAAI4B,MAAM,GAAG,EAAb;;EACA,KAAK,IAAMC,QAAX,IAAuBxD,aAAvB,EAAsC;IACpC,IAAMyD,YAAY,GAAGzD,aAAa,CAACwD,QAAD,CAAlC;IACAD,MAAM,mBAAYE,YAAY,CAACC,SAAzB,SAAN;;IACA,IAAID,YAAY,CAACE,MAAjB,EAAyB;MACvBJ,MAAM,gBAASE,YAAY,CAACE,MAAtB,CAAN;IACD;;IACD,IAAIhC,cAAc,CAAC6B,QAAD,CAAlB,EAA8B;MAC5B,IAAMjB,UAAU,GAAGZ,cAAc,CAAC6B,QAAD,CAAjC;MACAjB,UAAU,CAACqB,IAAX,CAAgB,UAACC,CAAD,EAAIC,CAAJ;QAAA,OAAUD,CAAC,CAAC7B,KAAF,GAAU8B,CAAC,CAAC9B,KAAtB;MAAA,CAAhB;;MAF4B,4CAGJO,UAHI;MAAA;;MAAA;QAG5B,uDAAoC;UAAA,IAAzBR,SAAyB;UAClCwB,MAAM,gBAASxB,SAAS,CAACA,SAAnB,OAAN;QACD;MAL2B;QAAA;MAAA;QAAA;MAAA;IAM7B;;IACD,IAAI0B,YAAY,CAACM,MAAjB,EAAyB;MACvBR,MAAM,gBAASE,YAAY,CAACM,MAAtB,CAAN;IACD;;IACDR,MAAM,IAAI,KAAV;EACD;;EAED,OAAOA,MAAP;AACD;;AAED,SAAS7B,sBAAT,CAAgC1B,aAAhC,EAA+C;EAC7C,IAAMuD,MAAM,GAAG;IACbpE,EAAE,EAAE,EADS;IAEbC,EAAE,EAAE;EAFS,CAAf;EAKAY,aAAa,CAACgB,OAAd,CAAsB,UAAAgD,IAAI,EAAI;IAC5B,IAAI9E,IAAJ;;IACA,IAAI,OAAO8E,IAAP,KAAgB,QAApB,EAA8B;MAC5B9E,IAAI,GAAG8E,IAAP;MACAA,IAAI,GAAG9E,IAAI,CAAC8E,IAAZ;IACD,CAHD,MAGO;MACL9E,IAAI,GAAG,EAAP;IACD;;IACD8E,IAAI,GAAGA,IAAI,CAACC,IAAL,EAAP;;IACA,kBAA2BD,IAAI,CAACxD,KAAL,CAAW,GAAX,CAA3B;IAAA;IAAA,IAAO0D,KAAP;IAAA,IAAcR,SAAd;;IACA,IAAMvB,IAAI,GAAG6B,IAAI,CAACG,OAAL,CAAa,MAAb,EAAqB,EAArB,CAAb;IACAZ,MAAM,CAACW,KAAD,CAAN,CAAc/B,IAAd,IAAsB3C,MAAM,CAACC,MAAP,CAAcP,IAAd,EAAoB;MAACwE,SAAS,EAATA;IAAD,CAApB,CAAtB;EACD,CAZD;EAcA,OAAOH,MAAP;AACD"}