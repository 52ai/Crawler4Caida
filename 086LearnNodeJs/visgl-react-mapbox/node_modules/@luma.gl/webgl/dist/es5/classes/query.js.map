{"version":3,"file":"query.js","names":["GL_QUERY_RESULT","GL_QUERY_RESULT_AVAILABLE","GL_TIME_ELAPSED_EXT","GL_GPU_DISJOINT_EXT","GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN","GL_ANY_SAMPLES_PASSED","GL_ANY_SAMPLES_PASSED_CONSERVATIVE","Query","gl","opts","target","_queryPending","_pollingPromise","Object","seal","begin","conservative","gl2","beginQuery","handle","endQuery","resultAvailable","getQueryParameter","getParameter","getResult","limit","Number","POSITIVE_INFINITY","counter","Promise","resolve","reject","poll","isResultAvailable","requestAnimationFrame","isSupported","createQuery","deleteQuery","webgl2","isWebGL2","hasTimerQuery","hasFeatures","FEATURES","TIMER_QUERY","supported","key","assert","Resource","Symbol","toStringTag"],"sources":["../../../src/classes/query.js"],"sourcesContent":["// WebGL2 Query (also handles disjoint timer extensions)\nimport Resource from './resource';\nimport {FEATURES, hasFeatures} from '../features';\nimport {isWebGL2} from '@luma.gl/gltools';\nimport {assert} from '../utils/assert';\n\nconst GL_QUERY_RESULT = 0x8866; // Returns a GLuint containing the query result.\nconst GL_QUERY_RESULT_AVAILABLE = 0x8867; // whether query result is available.\n\nconst GL_TIME_ELAPSED_EXT = 0x88bf; // Elapsed time (in nanoseconds).\nconst GL_GPU_DISJOINT_EXT = 0x8fbb; // Whether GPU performed any disjoint operation.\n\nconst GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN = 0x8c88; // #primitives written to feedback buffers\nconst GL_ANY_SAMPLES_PASSED = 0x8c2f; // Occlusion query (if drawing passed depth test)\nconst GL_ANY_SAMPLES_PASSED_CONSERVATIVE = 0x8d6a; // Occlusion query less accurate/faster version\n\nexport default class Query extends Resource {\n  // eslint-disable-next-line accessor-pairs\n  get [Symbol.toStringTag]() {\n    return 'Query';\n  }\n  // Returns true if Query is supported by the WebGL implementation\n  // Can also check whether timestamp queries are available.\n  static isSupported(gl, opts = []) {\n    const webgl2 = isWebGL2(gl);\n\n    // Initial value\n    const hasTimerQuery = hasFeatures(gl, FEATURES.TIMER_QUERY);\n    let supported = webgl2 || hasTimerQuery;\n\n    for (const key of opts) {\n      switch (key) {\n        case 'queries':\n          supported = supported && webgl2;\n          break;\n        case 'timers':\n          supported = supported && hasTimerQuery;\n          break;\n        default:\n          assert(false);\n      }\n    }\n\n    return supported;\n  }\n\n  // Create a query class\n  constructor(gl, opts = {}) {\n    super(gl, opts);\n\n    this.target = null;\n    this._queryPending = false;\n    this._pollingPromise = null;\n\n    Object.seal(this);\n  }\n\n  // Shortcut for timer query (dependent on extension in both WebGL1 and 2)\n  // Measures GPU time delta between this call and a matching `end` call in the\n  // GPU instruction stream.\n  beginTimeElapsedQuery() {\n    return this.begin(GL_TIME_ELAPSED_EXT);\n  }\n\n  // Shortcut for occlusion queries\n  beginOcclusionQuery({conservative = false} = {}) {\n    return this.begin(conservative ? GL_ANY_SAMPLES_PASSED_CONSERVATIVE : GL_ANY_SAMPLES_PASSED);\n  }\n\n  // Shortcut for transformFeedbackQuery\n  beginTransformFeedbackQuery() {\n    return this.begin(GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN);\n  }\n\n  // Due to OpenGL API limitations, after calling `begin()` on one Query\n  // instance, `end()` must be called on that same instance before\n  // calling `begin()` on another query. While there can be multiple\n  // outstanding queries representing disjoint `begin()`/`end()` intervals.\n  // It is not possible to interleave or overlap `begin` and `end` calls.\n  begin(target) {\n    // Don't start a new query if one is already active.\n    if (this._queryPending) {\n      return this;\n    }\n\n    this.target = target;\n    this.gl2.beginQuery(this.target, this.handle);\n\n    return this;\n  }\n\n  // ends the current query\n  end() {\n    // Can't end a new query if the last one hasn't been resolved.\n    if (this._queryPending) {\n      return this;\n    }\n\n    if (this.target) {\n      this.gl2.endQuery(this.target);\n      this.target = null;\n      this._queryPending = true;\n    }\n    return this;\n  }\n\n  // Returns true if the query result is available\n  isResultAvailable() {\n    if (!this._queryPending) {\n      return false;\n    }\n\n    const resultAvailable = this.gl2.getQueryParameter(this.handle, GL_QUERY_RESULT_AVAILABLE);\n    if (resultAvailable) {\n      this._queryPending = false;\n    }\n    return resultAvailable;\n  }\n\n  // Timing query is disjoint, i.e. results are invalid\n  isTimerDisjoint() {\n    return this.gl2.getParameter(GL_GPU_DISJOINT_EXT);\n  }\n\n  // Returns query result.\n  getResult() {\n    return this.gl2.getQueryParameter(this.handle, GL_QUERY_RESULT);\n  }\n\n  // Returns the query result, converted to milliseconds to match JavaScript conventions.\n  getTimerMilliseconds() {\n    return this.getResult() / 1e6;\n  }\n\n  // Polls the query\n  createPoll(limit = Number.POSITIVE_INFINITY) {\n    if (this._pollingPromise) {\n      return this._pollingPromise;\n    }\n\n    let counter = 0;\n\n    this._pollingPromise = new Promise((resolve, reject) => {\n      const poll = () => {\n        if (this.isResultAvailable()) {\n          resolve(this.getResult());\n          this._pollingPromise = null;\n        } else if (counter++ > limit) {\n          reject('Timed out');\n          this._pollingPromise = null;\n        } else {\n          requestAnimationFrame(poll);\n        }\n      };\n\n      requestAnimationFrame(poll);\n    });\n\n    return this._pollingPromise;\n  }\n\n  _createHandle() {\n    return Query.isSupported(this.gl) ? this.gl2.createQuery() : null;\n  }\n\n  _deleteHandle() {\n    this.gl2.deleteQuery(this.handle);\n  }\n}\n"],"mappings":"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"}