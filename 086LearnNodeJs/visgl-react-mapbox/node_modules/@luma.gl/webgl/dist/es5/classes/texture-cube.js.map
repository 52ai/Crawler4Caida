{"version":3,"file":"texture-cube.js","names":["FACES","TextureCube","gl","props","assertWebGLContext","Object","assign","target","initialize","seal","mipmaps","parameters","opts","setCubeMapImageData","then","loaded","generateMipmap","setParameters","face","data","x","y","mipmapLevel","_subImage","width","height","pixels","border","format","type","imageDataMap","Promise","all","map","facePixels","Array","isArray","resolvedFaces","bind","forEach","index","length","log","warn","id","image","lodLevel","texImage2D","unbind","options","imageData","resolvedImageData","setImageDataForFace","Texture","Symbol","toStringTag"],"sources":["../../../src/classes/texture-cube.js"],"sourcesContent":["import GL from '@luma.gl/constants';\nimport {log, assertWebGLContext} from '@luma.gl/gltools';\nimport Texture from './texture';\n\nconst FACES = [\n  GL.TEXTURE_CUBE_MAP_POSITIVE_X,\n  GL.TEXTURE_CUBE_MAP_NEGATIVE_X,\n  GL.TEXTURE_CUBE_MAP_POSITIVE_Y,\n  GL.TEXTURE_CUBE_MAP_NEGATIVE_Y,\n  GL.TEXTURE_CUBE_MAP_POSITIVE_Z,\n  GL.TEXTURE_CUBE_MAP_NEGATIVE_Z\n];\n\nexport default class TextureCube extends Texture {\n  // eslint-disable-next-line accessor-pairs\n  get [Symbol.toStringTag]() {\n    return 'TextureCube';\n  }\n\n  constructor(gl, props = {}) {\n    assertWebGLContext(gl);\n\n    super(gl, Object.assign({}, props, {target: GL.TEXTURE_CUBE_MAP}));\n\n    this.initialize(props);\n\n    Object.seal(this);\n  }\n\n  initialize(props = {}) {\n    const {mipmaps = true, parameters = {}} = props;\n\n    // Store props for accessors\n    this.opts = props;\n\n    // @ts-ignore\n    this.setCubeMapImageData(props).then(() => {\n      this.loaded = true;\n\n      // TODO - should genMipmap() be called on the cubemap or on the faces?\n      // TODO - without generateMipmap() cube textures do not work at all!!! Why?\n      if (mipmaps) {\n        this.generateMipmap(props);\n      }\n\n      this.setParameters(parameters);\n    });\n    return this;\n  }\n\n  subImage({face, data, x = 0, y = 0, mipmapLevel = 0}) {\n    // @ts-ignore TODO - is this a bug?\n    return this._subImage({target: face, data, x, y, mipmapLevel});\n  }\n\n  /* eslint-disable max-statements, max-len */\n  async setCubeMapImageData({\n    width,\n    height,\n    pixels,\n    data,\n    border = 0,\n    format = GL.RGBA,\n    type = GL.UNSIGNED_BYTE\n  }) {\n    const {gl} = this;\n    const imageDataMap = pixels || data;\n\n    // pixel data (imageDataMap) is an Object from Face to Image or Promise.\n    // For example:\n    // {\n    // GL.TEXTURE_CUBE_MAP_POSITIVE_X : Image-or-Promise,\n    // GL.TEXTURE_CUBE_MAP_NEGATIVE_X : Image-or-Promise,\n    // ... }\n    // To provide multiple level-of-details (LODs) this can be Face to Array\n    // of Image or Promise, like this\n    // {\n    // GL.TEXTURE_CUBE_MAP_POSITIVE_X : [Image-or-Promise-LOD-0, Image-or-Promise-LOD-1],\n    // GL.TEXTURE_CUBE_MAP_NEGATIVE_X : [Image-or-Promise-LOD-0, Image-or-Promise-LOD-1],\n    // ... }\n\n    const resolvedFaces = await Promise.all(\n      FACES.map(face => {\n        const facePixels = imageDataMap[face];\n        return Promise.all(Array.isArray(facePixels) ? facePixels : [facePixels]);\n      })\n    );\n\n    this.bind();\n\n    FACES.forEach((face, index) => {\n      if (resolvedFaces[index].length > 1 && this.opts.mipmaps !== false) {\n        // If the user provides multiple LODs, then automatic mipmap\n        // generation generateMipmap() should be disabled to avoid overwritting them.\n        log.warn(`${this.id} has mipmap and multiple LODs.`)();\n      }\n      resolvedFaces[index].forEach((image, lodLevel) => {\n        // TODO: adjust width & height for LOD!\n        if (width && height) {\n          gl.texImage2D(face, lodLevel, format, width, height, border, format, type, image);\n        } else {\n          gl.texImage2D(face, lodLevel, format, format, type, image);\n        }\n      });\n    });\n\n    this.unbind();\n  }\n\n  // TODO: update this method to accept LODs\n  setImageDataForFace(options) {\n    const {\n      face,\n      width,\n      height,\n      pixels,\n      data,\n      border = 0,\n      format = GL.RGBA,\n      type = GL.UNSIGNED_BYTE\n      // generateMipmap = false // TODO\n    } = options;\n\n    const {gl} = this;\n\n    const imageData = pixels || data;\n\n    this.bind();\n    if (imageData instanceof Promise) {\n      imageData.then(resolvedImageData =>\n        this.setImageDataForFace(\n          Object.assign({}, options, {\n            face,\n            data: resolvedImageData,\n            pixels: resolvedImageData\n          })\n        )\n      );\n    } else if (this.width || this.height) {\n      gl.texImage2D(face, 0, format, width, height, border, format, type, imageData);\n    } else {\n      gl.texImage2D(face, 0, format, format, type, imageData);\n    }\n\n    return this;\n  }\n}\n\nTextureCube.FACES = FACES;\n"],"mappings":"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"}