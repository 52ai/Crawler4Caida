{"version":3,"file":"program-configuration.js","names":["ProgramConfiguration","program","id","attributeInfos","attributeInfosByName","attributeInfosByLocation","varyingInfos","varyingInfosByName","Object","seal","_readAttributesFromProgram","_readVaryingsFromProgram","locationOrName","location","Number","isFinite","attributeInfo","getAttributeInfo","accessor","varying","getVaryingInfo","gl","count","getProgramParameter","handle","index","getActiveAttrib","name","type","size","getAttribLocation","_addAttribute","sort","a","b","isWebGL2","getTransformFeedbackVarying","_addVarying","compositeType","decomposeCompositeGLType","components","_inferProperties","Accessor","push","test","divisor"],"sources":["../../../src/classes/program-configuration.js"],"sourcesContent":["// Contains metadata describing attribute configurations for a program's shaders\n// Much of this is automatically extracted from shaders after program linking\nimport Accessor from './accessor';\nimport {isWebGL2} from '@luma.gl/gltools';\nimport {decomposeCompositeGLType} from '../webgl-utils/attribute-utils';\n\nexport default class ProgramConfiguration {\n  constructor(program) {\n    this.id = program.id;\n    this.attributeInfos = [];\n    this.attributeInfosByName = {};\n\n    // Locations may not be contiguous the case of matrix attributes\n    // so keep a separate location->attribute map.\n    this.attributeInfosByLocation = [];\n    this.varyingInfos = [];\n    this.varyingInfosByName = {};\n    Object.seal(this);\n    this._readAttributesFromProgram(program);\n    this._readVaryingsFromProgram(program);\n  }\n\n  getAttributeInfo(locationOrName) {\n    const location = Number(locationOrName);\n    if (Number.isFinite(location)) {\n      return this.attributeInfosByLocation[location];\n    }\n    return this.attributeInfosByName[locationOrName] || null;\n  }\n\n  // Resolves an attribute name or index to an index\n  getAttributeLocation(locationOrName) {\n    const attributeInfo = this.getAttributeInfo(locationOrName);\n    return attributeInfo ? attributeInfo.location : -1;\n  }\n\n  getAttributeAccessor(locationOrName) {\n    const attributeInfo = this.getAttributeInfo(locationOrName);\n    return attributeInfo ? attributeInfo.accessor : null;\n  }\n\n  getVaryingInfo(locationOrName) {\n    const location = Number(locationOrName);\n    if (Number.isFinite(location)) {\n      return this.varyingInfos[location];\n    }\n    return this.varyingInfosByName[locationOrName] || null;\n  }\n\n  getVaryingIndex(locationOrName) {\n    const varying = this.getVaryingInfo();\n    return varying ? varying.location : -1;\n  }\n\n  getVaryingAccessor(locationOrName) {\n    const varying = this.getVaryingInfo();\n    return varying ? varying.accessor : null;\n  }\n\n  // PRIVATE METHODS\n\n  // linkProgram needs to have been called, although linking does not need to have been successful\n  _readAttributesFromProgram(program) {\n    const {gl} = program;\n    const count = gl.getProgramParameter(program.handle, gl.ACTIVE_ATTRIBUTES);\n\n    for (let index = 0; index < count; index++) {\n      const {name, type, size} = gl.getActiveAttrib(program.handle, index);\n      const location = gl.getAttribLocation(program.handle, name);\n      // Add only user provided attributes, for built-in attributes like\n      // `gl_InstanceID` locaiton will be < 0\n      if (location >= 0) {\n        this._addAttribute(location, name, type, size);\n      }\n    }\n\n    this.attributeInfos.sort((a, b) => a.location - b.location);\n  }\n\n  // linkProgram needs to have been called, although linking does not need to have been successful\n  _readVaryingsFromProgram(program) {\n    const {gl} = program;\n    if (!isWebGL2(gl)) {\n      return;\n    }\n\n    const count = gl.getProgramParameter(program.handle, gl.TRANSFORM_FEEDBACK_VARYINGS);\n    for (let location = 0; location < count; location++) {\n      const {name, type, size} = gl.getTransformFeedbackVarying(program.handle, location);\n      this._addVarying(location, name, type, size);\n    }\n\n    this.varyingInfos.sort((a, b) => a.location - b.location);\n  }\n\n  _addAttribute(location, name, compositeType, size) {\n    const {type, components} = decomposeCompositeGLType(compositeType);\n    const accessor = {type, size: size * components};\n    this._inferProperties(location, name, accessor);\n\n    const attributeInfo = {location, name, accessor: new Accessor(accessor)}; // Base values\n    this.attributeInfos.push(attributeInfo);\n    this.attributeInfosByLocation[location] = attributeInfo; // For quick location based lookup\n    this.attributeInfosByName[attributeInfo.name] = attributeInfo; // For quick name based lookup\n  }\n\n  // Extract additional attribute metadata from shader names (based on attribute naming conventions)\n  _inferProperties(location, name, accessor) {\n    if (/instance/i.test(name)) {\n      // Any attribute containing the word \"instance\" will be assumed to be instanced\n      accessor.divisor = 1;\n    }\n  }\n\n  _addVarying(location, name, compositeType, size) {\n    const {type, components} = decomposeCompositeGLType(compositeType);\n    const accessor = new Accessor({type, size: size * components});\n\n    const varying = {location, name, accessor}; // Base values\n    this.varyingInfos.push(varying);\n    this.varyingInfosByName[varying.name] = varying; // For quick name based lookup\n  }\n}\n"],"mappings":"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"}