{"version":3,"sources":["../../../src/debug/loggers.ts"],"names":["logState","attributeUpdateStart","attributeManagerUpdateStart","attributeUpdateMessages","LOG_LEVEL_MAJOR_UPDATE","LOG_LEVEL_MINOR_UPDATE","LOG_LEVEL_UPDATE_DETAIL","LOG_LEVEL_INFO","LOG_LEVEL_DRAW","getLoggers","log","layer","key","flags","id","needsUpdate","getChangeFlags","Object","keys","filter","join","changed","updated","subLayers","layerManager","layers","length","viewport","attributeManager","trigger","attributeNames","Date","now","numInstances","timeMs","Math","round","groupCollapsed","updateMessage","groupEnd","attribute","message","push","deckRenderer","renderStats","opts","pass","redrawReason","stats","status","totalCount","visibleCount","compositeCount","pickableCount","primitiveCount","hiddenCount","renderCount","get","add"],"mappings":"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","sourcesContent":["import type {Log} from '@probe.gl/log';\n\nconst logState: {\n  attributeUpdateStart: number;\n  attributeManagerUpdateStart: number;\n  attributeUpdateMessages: string[];\n} = {\n  attributeUpdateStart: -1,\n  attributeManagerUpdateStart: -1,\n  attributeUpdateMessages: []\n};\n\nconst LOG_LEVEL_MAJOR_UPDATE = 1; // Events with direct perf impact\nconst LOG_LEVEL_MINOR_UPDATE = 2; // Events that may affect perf\nconst LOG_LEVEL_UPDATE_DETAIL = 3;\nconst LOG_LEVEL_INFO = 4;\nconst LOG_LEVEL_DRAW = 2;\n\nexport const getLoggers = (log: Log): Record<string, Function> => ({\n  /* Layer events */\n\n  'layer.changeFlag': (layer, key, flags) => {\n    log.log(LOG_LEVEL_UPDATE_DETAIL, `${layer.id} ${key}: `, flags[key])();\n  },\n\n  'layer.initialize': layer => {\n    log.log(LOG_LEVEL_MAJOR_UPDATE, `Initializing ${layer}`)();\n  },\n  'layer.update': (layer, needsUpdate) => {\n    if (needsUpdate) {\n      const flags = layer.getChangeFlags();\n      log.log(\n        LOG_LEVEL_MINOR_UPDATE,\n        `Updating ${layer} because: ${Object.keys(flags)\n          .filter(key => flags[key])\n          .join(', ')}`\n      )();\n    } else {\n      log.log(LOG_LEVEL_INFO, `${layer} does not need update`)();\n    }\n  },\n  'layer.matched': (layer, changed) => {\n    if (changed) {\n      log.log(LOG_LEVEL_INFO, `Matched ${layer}, state transfered`)();\n    }\n  },\n  'layer.finalize': layer => {\n    log.log(LOG_LEVEL_MAJOR_UPDATE, `Finalizing ${layer}`)();\n  },\n\n  /* CompositeLayer events */\n\n  'compositeLayer.renderLayers': (layer, updated, subLayers) => {\n    if (updated) {\n      log.log(\n        LOG_LEVEL_MINOR_UPDATE,\n        `Composite layer rendered new subLayers ${layer}`,\n        subLayers\n      )();\n    } else {\n      log.log(LOG_LEVEL_INFO, `Composite layer reused subLayers ${layer}`, subLayers)();\n    }\n  },\n\n  /* LayerManager events */\n\n  'layerManager.setLayers': (layerManager, updated, layers) => {\n    if (updated) {\n      log.log(LOG_LEVEL_MINOR_UPDATE, `Updating ${layers.length} deck layers`)();\n    }\n  },\n\n  'layerManager.activateViewport': (layerManager, viewport) => {\n    log.log(LOG_LEVEL_UPDATE_DETAIL, 'Viewport changed', viewport)();\n  },\n\n  /* AttributeManager events */\n\n  'attributeManager.invalidate': (attributeManager, trigger, attributeNames) => {\n    log.log(\n      LOG_LEVEL_MAJOR_UPDATE,\n      attributeNames\n        ? `invalidated attributes ${attributeNames} (${trigger}) for ${attributeManager.id}`\n        : `invalidated all attributes for ${attributeManager.id}`\n    )();\n  },\n\n  'attributeManager.updateStart': attributeManager => {\n    logState.attributeUpdateMessages.length = 0;\n    logState.attributeManagerUpdateStart = Date.now();\n  },\n  'attributeManager.updateEnd': (attributeManager, numInstances) => {\n    const timeMs = Math.round(Date.now() - logState.attributeManagerUpdateStart);\n    log.groupCollapsed(\n      LOG_LEVEL_MINOR_UPDATE,\n      `Updated attributes for ${numInstances} instances in ${attributeManager.id} in ${timeMs}ms`\n    )();\n    for (const updateMessage of logState.attributeUpdateMessages) {\n      log.log(LOG_LEVEL_UPDATE_DETAIL, updateMessage)();\n    }\n    log.groupEnd(LOG_LEVEL_MINOR_UPDATE)();\n  },\n\n  /* Attribute events */\n\n  'attribute.updateStart': attribute => {\n    logState.attributeUpdateStart = Date.now();\n  },\n  'attribute.allocate': (attribute, numInstances) => {\n    const message = `${attribute.id} allocated ${numInstances}`;\n    logState.attributeUpdateMessages.push(message);\n  },\n  'attribute.updateEnd': (attribute, numInstances) => {\n    const timeMs = Math.round(Date.now() - logState.attributeUpdateStart);\n    const message = `${attribute.id} updated ${numInstances} in ${timeMs}ms`;\n    logState.attributeUpdateMessages.push(message);\n  },\n\n  /* Render events */\n\n  'deckRenderer.renderLayers': (deckRenderer, renderStats, opts) => {\n    const {pass, redrawReason, stats} = opts;\n    for (const status of renderStats) {\n      const {totalCount, visibleCount, compositeCount, pickableCount} = status;\n      const primitiveCount = totalCount - compositeCount;\n      const hiddenCount = primitiveCount - visibleCount;\n\n      log.log(\n        LOG_LEVEL_DRAW,\n        `RENDER #${deckRenderer.renderCount} \\\n  ${visibleCount} (of ${totalCount} layers) to ${pass} because ${redrawReason} \\\n  (${hiddenCount} hidden, ${compositeCount} composite ${pickableCount} pickable)`\n      )();\n\n      if (stats) {\n        stats.get('Redraw Layers').add(visibleCount);\n      }\n    }\n  }\n});\n"],"file":"loggers.js"}