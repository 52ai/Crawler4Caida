{"version":3,"sources":["../../../src/viewports/viewport.ts"],"names":["DEGREES_TO_RADIANS","Math","PI","IDENTITY","ZERO_VECTOR","DEFAULT_DISTANCE_SCALES","unitsPerMeter","metersPerUnit","createProjectionMatrix","width","height","orthographic","fovyRadians","focalDistance","padding","near","far","aspect","matrix","Matrix4","fovy","perspective","left","right","top","bottom","offsetX","offsetY","Viewport","opts","id","constructor","displayName","x","y","zoom","distanceScales","position","modelMatrix","longitude","latitude","isGeospatial","Number","isFinite","_initProps","_initMatrices","equals","bind","project","unproject","projectPosition","unprojectPosition","projectFlat","unprojectFlat","scale","PROJECTION_MODE","WEB_MERCATOR","WEB_MERCATOR_AUTO_OFFSET","viewport","projectionMatrix","viewMatrix","xyz","topLeft","worldPosition","coord","pixelProjectionMatrix","y2","length","targetZ","z","targetZWorld","pixelUnprojectionMatrix","X","Y","Z","result","options","unprojectOption","topRight","bottomLeft","bottomRight","min","max","coordinateOrigin","highPrecision","_frustumPlanes","Object","assign","viewProjectionMatrix","coords","pixel","log2","pow","meterOffset","transformAsVector","center","Vector3","add","viewMatrixUncentered","multiplyRight","translate","negate","vpm","mat4","multiply","viewMatrixInverse","invert","cameraPosition","viewportMatrix","log","warn"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport log from '../utils/log';\nimport {createMat4, getCameraPosition, getFrustumPlanes, FrustumPlane} from '../utils/math-utils';\n\nimport {Matrix4, Vector3, equals, clamp} from '@math.gl/core';\nimport * as mat4 from 'gl-matrix/mat4';\n\nimport {\n  getDistanceScales,\n  getMeterZoom,\n  lngLatToWorld,\n  worldToLngLat,\n  worldToPixels,\n  pixelsToWorld\n} from '@math.gl/web-mercator';\n\nimport {PROJECTION_MODE} from '../lib/constants';\n\nexport type DistanceScales = {\n  unitsPerMeter: number[];\n  metersPerUnit: number[];\n};\n\nexport type Padding = {\n  left?: number;\n  right?: number;\n  top?: number;\n  bottom?: number;\n};\n\nexport type ViewportOptions = {\n  /** Name of the viewport */\n  id?: string;\n  /** Left offset from the canvas edge, in pixels */\n  x?: number;\n  /** Top offset from the canvas edge, in pixels */\n  y?: number;\n  /** Viewport width in pixels */\n  width?: number;\n  /** Viewport height in pixels */\n  height?: number;\n  /** Longitude in degrees (geospatial only) */\n  longitude?: number;\n  /** Latitude in degrees (geospatial only) */\n  latitude?: number;\n  /** Viewport center in world space. If geospatial, refers to meter offsets from lng, lat */\n  position?: number[];\n  /** Zoom level */\n  zoom?: number;\n  /** Padding around the viewport, in pixels. */\n  padding?: Padding | null;\n  distanceScales?: DistanceScales;\n  /** Model matrix of viewport center */\n  modelMatrix?: number[] | null;\n  /** Custom view matrix */\n  viewMatrix?: number[];\n  /** Custom projection matrix */\n  projectionMatrix?: number[];\n  /** Modifier of viewport scale. Corresponds to the number of pixels per common unit at zoom 0. */\n  focalDistance?: number;\n  /** Use orthographic projection */\n  orthographic?: boolean;\n  /** fovy in radians. If supplied, overrides fovy */\n  fovyRadians?: number;\n  /** fovy in degrees. */\n  fovy?: number;\n  /** Near plane of the projection matrix */\n  near?: number;\n  /** Far plane of the projection matrix */\n  far?: number;\n};\n\nconst DEGREES_TO_RADIANS = Math.PI / 180;\n\nconst IDENTITY = createMat4();\n\nconst ZERO_VECTOR = [0, 0, 0];\n\nconst DEFAULT_DISTANCE_SCALES: DistanceScales = {\n  unitsPerMeter: [1, 1, 1],\n  metersPerUnit: [1, 1, 1]\n};\n\n// / Helpers\nfunction createProjectionMatrix({\n  width,\n  height,\n  orthographic,\n  fovyRadians,\n  focalDistance,\n  padding,\n  near,\n  far\n}: {\n  width: number;\n  height: number;\n  orthographic: boolean;\n  fovyRadians: number;\n  focalDistance: number;\n  padding: Padding | null;\n  near: number;\n  far: number;\n}) {\n  const aspect = width / height;\n  const matrix = orthographic\n    ? new Matrix4().orthographic({fovy: fovyRadians, aspect, focalDistance, near, far})\n    : new Matrix4().perspective({fovy: fovyRadians, aspect, near, far});\n  if (padding) {\n    const {left = 0, right = 0, top = 0, bottom = 0} = padding;\n    const offsetX = clamp((left + width - right) / 2, 0, width) - width / 2;\n    const offsetY = clamp((top + height - bottom) / 2, 0, height) - height / 2;\n    // pixels to clip space\n    matrix[8] -= (offsetX * 2) / width;\n    matrix[9] += (offsetY * 2) / height;\n  }\n  return matrix;\n}\n\n/**\n * Manages coordinate system transformations.\n *\n * Note: The Viewport is immutable in the sense that it only has accessors.\n * A new viewport instance should be created if any parameters have changed.\n */\nexport default class Viewport {\n  static displayName = 'Viewport';\n\n  /** Init parameters */\n\n  id: string;\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  isGeospatial: boolean;\n  zoom: number;\n  focalDistance: number;\n  position: number[];\n  modelMatrix: number[] | null;\n\n  /** Derived parameters */\n\n  // `!` post-fix expression operator asserts that its operand is non-null and non-undefined in contexts\n  // where the type checker is unable to conclude that fact.\n\n  distanceScales: DistanceScales; /** scale factors between world space and common space */\n  scale!: number; /** scale factor, equals 2^zoom */\n  center!: number[]; /** viewport center in common space */\n  cameraPosition!: number[]; /** Camera position in common space */\n  projectionMatrix!: number[];\n  viewMatrix!: number[];\n  viewMatrixUncentered!: number[];\n  viewMatrixInverse!: number[];\n  viewProjectionMatrix!: number[];\n  pixelProjectionMatrix!: number[];\n  pixelUnprojectionMatrix!: number[];\n  resolution?: number;\n\n  private _frustumPlanes: {[name: string]: FrustumPlane} = {};\n\n  constructor(opts: ViewportOptions = {}) {\n    // @ts-ignore\n    this.id = opts.id || this.constructor.displayName || 'viewport';\n\n    this.x = opts.x || 0;\n    this.y = opts.y || 0;\n    // Silently allow apps to send in w,h = 0,0\n    this.width = opts.width || 1;\n    this.height = opts.height || 1;\n    this.zoom = opts.zoom || 0;\n    this.distanceScales = opts.distanceScales || DEFAULT_DISTANCE_SCALES;\n    this.focalDistance = opts.focalDistance || 1;\n    this.position = opts.position || ZERO_VECTOR;\n    this.modelMatrix = opts.modelMatrix || null;\n\n    const {longitude, latitude} = opts;\n    this.isGeospatial = Number.isFinite(latitude) && Number.isFinite(longitude);\n\n    this._initProps(opts);\n    this._initMatrices(opts);\n\n    // Bind methods for easy access\n    this.equals = this.equals.bind(this);\n    this.project = this.project.bind(this);\n    this.unproject = this.unproject.bind(this);\n    this.projectPosition = this.projectPosition.bind(this);\n    this.unprojectPosition = this.unprojectPosition.bind(this);\n    this.projectFlat = this.projectFlat.bind(this);\n    this.unprojectFlat = this.unprojectFlat.bind(this);\n  }\n\n  get metersPerPixel(): number {\n    return this.distanceScales.metersPerUnit[2] / this.scale;\n  }\n\n  get projectionMode(): number {\n    if (this.isGeospatial) {\n      return this.zoom < 12\n        ? PROJECTION_MODE.WEB_MERCATOR\n        : PROJECTION_MODE.WEB_MERCATOR_AUTO_OFFSET;\n    }\n    return PROJECTION_MODE.IDENTITY;\n  }\n\n  // Two viewports are equal if width and height are identical, and if\n  // their view and projection matrices are (approximately) equal.\n  equals(viewport: Viewport): boolean {\n    if (!(viewport instanceof Viewport)) {\n      return false;\n    }\n    if (this === viewport) {\n      return true;\n    }\n\n    return (\n      viewport.width === this.width &&\n      viewport.height === this.height &&\n      viewport.scale === this.scale &&\n      equals(viewport.projectionMatrix, this.projectionMatrix) &&\n      equals(viewport.viewMatrix, this.viewMatrix)\n    );\n    // TODO - check distance scales?\n  }\n\n  /**\n   * Projects xyz (possibly latitude and longitude) to pixel coordinates in window\n   * using viewport projection parameters\n   * - [longitude, latitude] to [x, y]\n   * - [longitude, latitude, Z] => [x, y, z]\n   * Note: By default, returns top-left coordinates for canvas/SVG type render\n   *\n   * @param {Array} lngLatZ - [lng, lat] or [lng, lat, Z]\n   * @param {Object} opts - options\n   * @param {Object} opts.topLeft=true - Whether projected coords are top left\n   * @return {Array} - [x, y] or [x, y, z] in top left coords\n   */\n  project(xyz: number[], {topLeft = true}: {topLeft?: boolean} = {}): number[] {\n    const worldPosition = this.projectPosition(xyz);\n    const coord = worldToPixels(worldPosition, this.pixelProjectionMatrix);\n\n    const [x, y] = coord;\n    const y2 = topLeft ? y : this.height - y;\n    return xyz.length === 2 ? [x, y2] : [x, y2, coord[2]];\n  }\n\n  /**\n   * Unproject pixel coordinates on screen onto world coordinates,\n   * (possibly [lon, lat]) on map.\n   * - [x, y] => [lng, lat]\n   * - [x, y, z] => [lng, lat, Z]\n   * @param {Array} xyz -\n   * @param {Object} opts - options\n   * @param {Object} opts.topLeft=true - Whether origin is top left\n   * @return {Array|null} - [lng, lat, Z] or [X, Y, Z]\n   */\n  unproject(\n    xyz: number[],\n    {topLeft = true, targetZ}: {topLeft?: boolean; targetZ?: number} = {}\n  ): number[] {\n    const [x, y, z] = xyz;\n\n    const y2 = topLeft ? y : this.height - y;\n    const targetZWorld = targetZ && targetZ * this.distanceScales.unitsPerMeter[2];\n    const coord = pixelsToWorld([x, y2, z], this.pixelUnprojectionMatrix, targetZWorld);\n    const [X, Y, Z] = this.unprojectPosition(coord);\n\n    if (Number.isFinite(z)) {\n      return [X, Y, Z];\n    }\n    return Number.isFinite(targetZ) ? [X, Y, targetZ as number] : [X, Y];\n  }\n\n  // NON_LINEAR PROJECTION HOOKS\n  // Used for web meractor projection\n\n  projectPosition(xyz: number[]): [number, number, number] {\n    const [X, Y] = this.projectFlat(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.unitsPerMeter[2];\n    return [X, Y, Z];\n  }\n\n  unprojectPosition(xyz: number[]): [number, number, number] {\n    const [X, Y] = this.unprojectFlat(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.metersPerUnit[2];\n    return [X, Y, Z];\n  }\n\n  /**\n   * Project [lng,lat] on sphere onto [x,y] on 512*512 Mercator Zoom 0 tile.\n   * Performs the nonlinear part of the web mercator projection.\n   * Remaining projection is done with 4x4 matrices which also handles\n   * perspective.\n   * @param {Array} lngLat - [lng, lat] coordinates\n   *   Specifies a point on the sphere to project onto the map.\n   * @return {Array} [x,y] coordinates.\n   */\n  projectFlat(xyz: number[]): [number, number] {\n    if (this.isGeospatial) {\n      // Shader clamps latitude to +-89.9, see /shaderlib/project/project.glsl.js\n      // lngLatToWorld([0, -89.9])[1] = -317.9934163758329\n      // lngLatToWorld([0, 89.9])[1] = 829.9934163758271\n      const result = lngLatToWorld(xyz);\n      result[1] = clamp(result[1], -318, 830);\n      return result;\n    }\n    return xyz as [number, number];\n  }\n\n  /**\n   * Unproject world point [x,y] on map onto {lat, lon} on sphere\n   * @param {object|Vector} xy - object with {x,y} members\n   *  representing point on projected map plane\n   * @return {GeoCoordinates} - object with {lat,lon} of point on sphere.\n   *   Has toArray method if you need a GeoJSON Array.\n   *   Per cartographic tradition, lat and lon are specified as degrees.\n   */\n  unprojectFlat(xyz: number[]): [number, number] {\n    if (this.isGeospatial) {\n      return worldToLngLat(xyz);\n    }\n    return xyz as [number, number];\n  }\n\n  /**\n   * Get bounds of the current viewport\n   * @return {Array} - [minX, minY, maxX, maxY]\n   */\n  getBounds(options: {z?: number} = {}): [number, number, number, number] {\n    const unprojectOption = {targetZ: options.z || 0};\n\n    const topLeft = this.unproject([0, 0], unprojectOption);\n    const topRight = this.unproject([this.width, 0], unprojectOption);\n    const bottomLeft = this.unproject([0, this.height], unprojectOption);\n    const bottomRight = this.unproject([this.width, this.height], unprojectOption);\n\n    return [\n      Math.min(topLeft[0], topRight[0], bottomLeft[0], bottomRight[0]),\n      Math.min(topLeft[1], topRight[1], bottomLeft[1], bottomRight[1]),\n      Math.max(topLeft[0], topRight[0], bottomLeft[0], bottomRight[0]),\n      Math.max(topLeft[1], topRight[1], bottomLeft[1], bottomRight[1])\n    ];\n  }\n\n  getDistanceScales(coordinateOrigin?: number[]): DistanceScales {\n    if (coordinateOrigin) {\n      return getDistanceScales({\n        longitude: coordinateOrigin[0],\n        latitude: coordinateOrigin[1],\n        highPrecision: true\n      });\n    }\n    return this.distanceScales;\n  }\n\n  containsPixel({\n    x,\n    y,\n    width = 1,\n    height = 1\n  }: {\n    x: number;\n    y: number;\n    width?: number;\n    height?: number;\n  }): boolean {\n    return (\n      x < this.x + this.width &&\n      this.x < x + width &&\n      y < this.y + this.height &&\n      this.y < y + height\n    );\n  }\n\n  // Extract frustum planes in common space\n  getFrustumPlanes(): {\n    left: FrustumPlane;\n    right: FrustumPlane;\n    bottom: FrustumPlane;\n    top: FrustumPlane;\n    near: FrustumPlane;\n    far: FrustumPlane;\n  } {\n    if (this._frustumPlanes.near) {\n      // @ts-ignore\n      return this._frustumPlanes;\n    }\n\n    Object.assign(this._frustumPlanes, getFrustumPlanes(this.viewProjectionMatrix));\n\n    // @ts-ignore\n    return this._frustumPlanes;\n  }\n\n  // EXPERIMENTAL METHODS\n\n  /**\n   * Needed by panning and linear transition\n   * Pan the viewport to place a given world coordinate at screen point [x, y]\n   *\n   * @param {Array} coords - world coordinates\n   * @param {Array} pixel - [x,y] coordinates on screen\n   * @return {Object} props of the new viewport\n   */\n  panByPosition(coords: number[], pixel: number[]): any {\n    return null;\n  }\n\n  // INTERNAL METHODS\n\n  /* eslint-disable complexity, max-statements */\n  private _initProps(opts: ViewportOptions) {\n    const longitude = opts.longitude as number;\n    const latitude = opts.latitude as number;\n\n    if (this.isGeospatial) {\n      if (!Number.isFinite(opts.zoom)) {\n        this.zoom = getMeterZoom({latitude}) + Math.log2(this.focalDistance);\n      }\n      this.distanceScales = opts.distanceScales || getDistanceScales({latitude, longitude});\n    }\n    const scale = Math.pow(2, this.zoom);\n    this.scale = scale;\n\n    const {position, modelMatrix} = opts;\n    let meterOffset: number[] = ZERO_VECTOR;\n    if (position) {\n      meterOffset = modelMatrix\n        ? (new Matrix4(modelMatrix).transformAsVector(position, []) as number[])\n        : position;\n    }\n\n    if (this.isGeospatial) {\n      // Determine camera center in common space\n      const center = this.projectPosition([longitude, latitude, 0]);\n\n      this.center = new Vector3(meterOffset)\n        // Convert to pixels in current zoom\n        .scale(this.distanceScales.unitsPerMeter)\n        .add(center);\n    } else {\n      this.center = this.projectPosition(meterOffset);\n    }\n  }\n  /* eslint-enable complexity, max-statements */\n\n  private _initMatrices(opts: ViewportOptions) {\n    const {\n      // View matrix\n      viewMatrix = IDENTITY,\n      // Projection matrix\n      projectionMatrix = null,\n\n      // Projection matrix parameters, used if projectionMatrix not supplied\n      orthographic = false,\n      fovyRadians,\n      fovy = 75,\n      near = 0.1, // Distance of near clipping plane\n      far = 1000, // Distance of far clipping plane\n      padding = null, // Center offset in pixels\n      focalDistance = 1\n    } = opts;\n\n    this.viewMatrixUncentered = viewMatrix;\n    // Make a centered version of the matrix for projection modes without an offset\n    this.viewMatrix = new Matrix4()\n      // Apply the uncentered view matrix\n      .multiplyRight(viewMatrix)\n      // And center it\n      .translate(new Vector3(this.center).negate());\n\n    this.projectionMatrix =\n      projectionMatrix ||\n      createProjectionMatrix({\n        width: this.width,\n        height: this.height,\n        orthographic,\n        fovyRadians: fovyRadians || fovy * DEGREES_TO_RADIANS,\n        focalDistance,\n        padding,\n        near,\n        far\n      });\n\n    // Note: As usual, matrix operations should be applied in \"reverse\" order\n    // since vectors will be multiplied in from the right during transformation\n    const vpm = createMat4();\n    mat4.multiply(vpm, vpm, this.projectionMatrix);\n    mat4.multiply(vpm, vpm, this.viewMatrix);\n    this.viewProjectionMatrix = vpm;\n\n    // console.log('VPM', this.viewMatrix, this.projectionMatrix, this.viewProjectionMatrix);\n\n    // Calculate inverse view matrix\n    this.viewMatrixInverse = mat4.invert([], this.viewMatrix) || this.viewMatrix;\n\n    // Decompose camera parameters\n    this.cameraPosition = getCameraPosition(this.viewMatrixInverse);\n\n    /*\n     * Builds matrices that converts preprojected lngLats to screen pixels\n     * and vice versa.\n     * Note: Currently returns bottom-left coordinates!\n     * Note: Starts with the GL projection matrix and adds steps to the\n     *       scale and translate that matrix onto the window.\n     * Note: WebGL controls clip space to screen projection with gl.viewport\n     *       and does not need this step.\n     */\n\n    // matrix for conversion from world location to screen (pixel) coordinates\n    const viewportMatrix = createMat4(); // matrix from NDC to viewport.\n    const pixelProjectionMatrix = createMat4(); // matrix from world space to viewport.\n    mat4.scale(viewportMatrix, viewportMatrix, [this.width / 2, -this.height / 2, 1]);\n    mat4.translate(viewportMatrix, viewportMatrix, [1, -1, 0]);\n    mat4.multiply(pixelProjectionMatrix, viewportMatrix, this.viewProjectionMatrix);\n    this.pixelProjectionMatrix = pixelProjectionMatrix;\n\n    this.pixelUnprojectionMatrix = mat4.invert(createMat4(), this.pixelProjectionMatrix);\n    if (!this.pixelUnprojectionMatrix) {\n      log.warn('Pixel project matrix not invertible')();\n      // throw new Error('Pixel project matrix not invertible');\n    }\n  }\n}\n"],"file":"viewport.js"}