{"version":3,"sources":["../../../../src/shaderlib/shadow/shadow.ts"],"names":["vs","fs","getMemoizedViewportCenterPosition","getViewportCenterPosition","getMemoizedViewProjectionMatrices","getViewProjectionMatrices","DEFAULT_SHADOW_COLOR","VECTOR_TO_POINT_MATRIX","screenToCommonSpace","xyz","pixelUnprojectionMatrix","x","y","z","coord","Number","isFinite","viewport","center","Matrix4","viewProjectionMatrix","invert","transform","shadowMatrices","projectionMatrices","farZ","isGeospatial","undefined","corners","width","height","map","pixel","shadowMatrix","viewMatrix","clone","translate","Vector3","negate","positions","corner","projectionMatrix","ortho","left","Math","min","position","right","max","bottom","top","near","far","push","multiplyRight","createShadowUniforms","opts","context","shadowEnabled","length","shadow_uDrawShadowMap","shadow_uUseShadowMap","uniforms","Boolean","drawToShadowMap","shadowMaps","shadow_uColor","shadowColor","shadow_uLightId","shadowLightId","shadow_uLightCount","project_uCenter","projectCenters","viewProjectionMatrices","slice","i","viewProjectionMatrixCentered","project_uCoordinateSystem","COORDINATE_SYSTEM","LNGLAT","project_uProjectionMode","PROJECTION_MODE","WEB_MERCATOR","dummyShadowMap","name","dependencies","project","inject","getUniforms"],"mappings":";;;;;;;;;;;;;AAmBA;;AACA;;AACA;;AACA;;AACA;;;;;;;;AAOA,IAAMA,EAAE,u+BAAR;AA2BA,IAAMC,EAAE,87CAAR;AA8CA,IAAMC,iCAAiC,GAAG,sBAAQC,yBAAR,CAA1C;AACA,IAAMC,iCAAiC,GAAG,sBAAQC,yBAAR,CAA1C;AAEA,IAAMC,oBAAoB,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,GAAV,CAA7B;AACA,IAAMC,sBAAsB,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,EAAa,CAAb,EAAgB,CAAhB,EAAmB,CAAnB,EAAsB,CAAtB,EAAyB,CAAzB,EAA4B,CAA5B,EAA+B,CAA/B,EAAkC,CAAlC,EAAqC,CAArC,EAAwC,CAAxC,EAA2C,CAA3C,EAA8C,CAA9C,CAA/B;;AAaA,SAASC,mBAAT,CAA6BC,GAA7B,EAA4CC,uBAA5C,EAAyF;AACvF,0CAAkBD,GAAlB;AAAA,MAAOE,CAAP;AAAA,MAAUC,CAAV;AAAA,MAAaC,CAAb;;AACA,MAAMC,KAAK,GAAG,gCAAc,CAACH,CAAD,EAAIC,CAAJ,EAAOC,CAAP,CAAd,EAAyBH,uBAAzB,CAAd;;AAEA,MAAIK,MAAM,CAACC,QAAP,CAAgBH,CAAhB,CAAJ,EAAwB;AACtB,WAAOC,KAAP;AACD;;AACD,SAAO,CAACA,KAAK,CAAC,CAAD,CAAN,EAAWA,KAAK,CAAC,CAAD,CAAhB,EAAqB,CAArB,CAAP;AACD;;AAED,SAASX,yBAAT,OAMiB;AAAA,MALfc,QAKe,QALfA,QAKe;AAAA,MAJfC,MAIe,QAJfA,MAIe;AACf,SAAO,IAAIC,aAAJ,CAAYF,QAAQ,CAACG,oBAArB,EAA2CC,MAA3C,GAAoDC,SAApD,CAA8DJ,MAA9D,CAAP;AACD;;AAED,SAASb,yBAAT,QAMc;AAAA,MALZY,QAKY,SALZA,QAKY;AAAA,MAJZM,cAIY,SAJZA,cAIY;AACZ,MAAMC,kBAA6B,GAAG,EAAtC;AACA,MAAMd,uBAAuB,GAAGO,QAAQ,CAACP,uBAAzC;AACA,MAAMe,IAAI,GAAGR,QAAQ,CAACS,YAAT,GAAwBC,SAAxB,GAAoC,CAAjD;AACA,MAAMC,OAAO,GAAG,CACd,CAAC,CAAD,EAAI,CAAJ,EAAOH,IAAP,CADc,EAEd,CAACR,QAAQ,CAACY,KAAV,EAAiB,CAAjB,EAAoBJ,IAApB,CAFc,EAGd,CAAC,CAAD,EAAIR,QAAQ,CAACa,MAAb,EAAqBL,IAArB,CAHc,EAId,CAACR,QAAQ,CAACY,KAAV,EAAiBZ,QAAQ,CAACa,MAA1B,EAAkCL,IAAlC,CAJc,EAKd,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAC,CAAR,CALc,EAMd,CAACR,QAAQ,CAACY,KAAV,EAAiB,CAAjB,EAAoB,CAAC,CAArB,CANc,EAOd,CAAC,CAAD,EAAIZ,QAAQ,CAACa,MAAb,EAAqB,CAAC,CAAtB,CAPc,EAQd,CAACb,QAAQ,CAACY,KAAV,EAAiBZ,QAAQ,CAACa,MAA1B,EAAkC,CAAC,CAAnC,CARc,EASdC,GATc,CASV,UAAAC,KAAK;AAAA,WAETxB,mBAAmB,CAACwB,KAAD,EAAQtB,uBAAR,CAFV;AAAA,GATK,CAAhB;;AAJY,6CAkBea,cAlBf;AAAA;;AAAA;AAAA;AAAA,UAkBDU,YAlBC;AAmBV,UAAMC,UAAU,GAAGD,YAAY,CAACE,KAAb,GAAqBC,SAArB,CAA+B,IAAIC,aAAJ,CAAYpB,QAAQ,CAACC,MAArB,EAA6BoB,MAA7B,EAA/B,CAAnB;AACA,UAAMC,SAAS,GAAGX,OAAO,CAACG,GAAR,CAAY,UAAAS,MAAM;AAAA,eAAIN,UAAU,CAACZ,SAAX,CAAqBkB,MAArB,CAAJ;AAAA,OAAlB,CAAlB;AACA,UAAMC,gBAAgB,GAAG,IAAItB,aAAJ,GAAcuB,KAAd,CAAoB;AAC3CC,QAAAA,IAAI,EAAEC,IAAI,CAACC,GAAL,OAAAD,IAAI,mCAAQL,SAAS,CAACR,GAAV,CAAc,UAAAe,QAAQ;AAAA,iBAAIA,QAAQ,CAAC,CAAD,CAAZ;AAAA,SAAtB,CAAR,EADiC;AAE3CC,QAAAA,KAAK,EAAEH,IAAI,CAACI,GAAL,OAAAJ,IAAI,mCAAQL,SAAS,CAACR,GAAV,CAAc,UAAAe,QAAQ;AAAA,iBAAIA,QAAQ,CAAC,CAAD,CAAZ;AAAA,SAAtB,CAAR,EAFgC;AAG3CG,QAAAA,MAAM,EAAEL,IAAI,CAACC,GAAL,OAAAD,IAAI,mCAAQL,SAAS,CAACR,GAAV,CAAc,UAAAe,QAAQ;AAAA,iBAAIA,QAAQ,CAAC,CAAD,CAAZ;AAAA,SAAtB,CAAR,EAH+B;AAI3CI,QAAAA,GAAG,EAAEN,IAAI,CAACI,GAAL,OAAAJ,IAAI,mCAAQL,SAAS,CAACR,GAAV,CAAc,UAAAe,QAAQ;AAAA,iBAAIA,QAAQ,CAAC,CAAD,CAAZ;AAAA,SAAtB,CAAR,EAJkC;AAK3CK,QAAAA,IAAI,EAAEP,IAAI,CAACC,GAAL,OAAAD,IAAI,mCAAQL,SAAS,CAACR,GAAV,CAAc,UAAAe,QAAQ;AAAA,iBAAI,CAACA,QAAQ,CAAC,CAAD,CAAb;AAAA,SAAtB,CAAR,EALiC;AAM3CM,QAAAA,GAAG,EAAER,IAAI,CAACI,GAAL,OAAAJ,IAAI,mCAAQL,SAAS,CAACR,GAAV,CAAc,UAAAe,QAAQ;AAAA,iBAAI,CAACA,QAAQ,CAAC,CAAD,CAAb;AAAA,SAAtB,CAAR;AANkC,OAApB,CAAzB;AAQAtB,MAAAA,kBAAkB,CAAC6B,IAAnB,CAAwBZ,gBAAgB,CAACa,aAAjB,CAA+BrB,YAA/B,CAAxB;AA7BU;;AAkBZ,wDAA2C;AAAA;AAY1C;AA9BW;AAAA;AAAA;AAAA;AAAA;;AA+BZ,SAAOT,kBAAP;AACD;;AAGD,SAAS+B,oBAAT,CACEC,IADF,EAEEC,OAFF,EAGuB;AACrB,4BAA+BD,IAA/B,CAAOE,aAAP;AAAA,MAAOA,aAAP,oCAAuB,IAAvB;;AACA,MAAI,CAACA,aAAD,IAAkB,CAACF,IAAI,CAACjC,cAAxB,IAA0C,CAACiC,IAAI,CAACjC,cAAL,CAAoBoC,MAAnE,EAA2E;AACzE,WAAO;AACLC,MAAAA,qBAAqB,EAAE,KADlB;AAELC,MAAAA,oBAAoB,EAAE;AAFjB,KAAP;AAID;;AACD,MAAMC,QAAQ,GAAG;AACfF,IAAAA,qBAAqB,EAAEG,OAAO,CAACP,IAAI,CAACQ,eAAN,CADf;AAEfH,IAAAA,oBAAoB,EAAEL,IAAI,CAACS,UAAL,GAAkBT,IAAI,CAACS,UAAL,CAAgBN,MAAhB,GAAyB,CAA3C,GAA+C,KAFtD;AAGfO,IAAAA,aAAa,EAAEV,IAAI,CAACW,WAAL,IAAoB7D,oBAHpB;AAIf8D,IAAAA,eAAe,EAAEZ,IAAI,CAACa,aAAL,IAAsB,CAJxB;AAKfC,IAAAA,kBAAkB,EAAEd,IAAI,CAACjC,cAAL,CAAoBoC;AALzB,GAAjB;AAQA,MAAMzC,MAAM,GAAGhB,iCAAiC,CAAC;AAC/Ce,IAAAA,QAAQ,EAAEuC,IAAI,CAACvC,QADgC;AAE/CC,IAAAA,MAAM,EAAEuC,OAAO,CAACc;AAF+B,GAAD,CAAhD;AAKA,MAAMC,cAA8B,GAAG,EAAvC;AACA,MAAMC,sBAAsB,GAAGrE,iCAAiC,CAAC;AAC/DmB,IAAAA,cAAc,EAAEiC,IAAI,CAACjC,cAD0C;AAE/DN,IAAAA,QAAQ,EAAEuC,IAAI,CAACvC;AAFgD,GAAD,CAAjC,CAG5ByD,KAH4B,EAA/B;;AAKA,OAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGnB,IAAI,CAACjC,cAAL,CAAoBoC,MAAxC,EAAgDgB,CAAC,EAAjD,EAAqD;AACnD,QAAMvD,oBAAoB,GAAGqD,sBAAsB,CAACE,CAAD,CAAnD;AACA,QAAMC,4BAA4B,GAAGxD,oBAAoB,CACtDe,KADkC,GAElCC,SAFkC,CAExB,IAAIC,aAAJ,CAAYmB,IAAI,CAACvC,QAAL,CAAcC,MAA1B,EAAkCoB,MAAlC,EAFwB,CAArC;;AAIA,QACEmB,OAAO,CAACoB,yBAAR,KAAsCC,6BAAkBC,MAAxD,IACAtB,OAAO,CAACuB,uBAAR,KAAoCC,2BAAgBC,YAFtD,EAGE;AACAT,MAAAA,sBAAsB,CAACE,CAAD,CAAtB,GAA4BC,4BAA5B;AACAJ,MAAAA,cAAc,CAACG,CAAD,CAAd,GAAoBzD,MAApB;AACD,KAND,MAMO;AACLuD,MAAAA,sBAAsB,CAACE,CAAD,CAAtB,GAA4BvD,oBAAoB,CAC7Ce,KADyB,GAEzBmB,aAFyB,CAEX/C,sBAFW,CAA5B;AAGAiE,MAAAA,cAAc,CAACG,CAAD,CAAd,GAAoBC,4BAA4B,CAACtD,SAA7B,CAAuCJ,MAAvC,CAApB;AACD;AACF;;AAED,OAAK,IAAIyD,EAAC,GAAG,CAAb,EAAgBA,EAAC,GAAGF,sBAAsB,CAACd,MAA3C,EAAmDgB,EAAC,EAApD,EAAwD;AACtDb,IAAAA,QAAQ,0CAAmCa,EAAnC,OAAR,GAAmDF,sBAAsB,CAACE,EAAD,CAAzE;AACAb,IAAAA,QAAQ,kCAA2Ba,EAA3B,OAAR,GAA2CH,cAAc,CAACG,EAAD,CAAzD;;AAEA,QAAInB,IAAI,CAACS,UAAL,IAAmBT,IAAI,CAACS,UAAL,CAAgBN,MAAhB,GAAyB,CAAhD,EAAmD;AACjDG,MAAAA,QAAQ,4BAAqBa,EAArB,EAAR,GAAoCnB,IAAI,CAACS,UAAL,CAAgBU,EAAhB,CAApC;AACD,KAFD,MAEO;AACLb,MAAAA,QAAQ,4BAAqBa,EAArB,EAAR,GAAoCnB,IAAI,CAAC2B,cAAzC;AACD;AACF;;AACD,SAAOrB,QAAP;AACD;;eAEc;AACbsB,EAAAA,IAAI,EAAE,QADO;AAEbC,EAAAA,YAAY,EAAE,CAACC,gBAAD,CAFD;AAGbtF,EAAAA,EAAE,EAAFA,EAHa;AAIbC,EAAAA,EAAE,EAAFA,EAJa;AAKbsF,EAAAA,MAAM,EAAE;AACN,yGADM;AAIN;AAJM,GALK;AAabC,EAAAA,WAAW,EAAE,uBAA6B;AAAA,QAA5BhC,IAA4B,uEAArB,EAAqB;AAAA,QAAjBC,OAAiB,uEAAP,EAAO;;AACxC,QACE,cAAcD,IAAd,KACCA,IAAI,CAACQ,eAAL,IAAyBR,IAAI,CAACS,UAAL,IAAmBT,IAAI,CAACS,UAAL,CAAgBN,MAAhB,GAAyB,CADtE,CADF,EAGE;AAEA,aAAOJ,oBAAoB,CAACC,IAAD,EAAOC,OAAP,CAA3B;AACD;;AACD,WAAO,EAAP;AACD;AAtBY,C","sourcesContent":["// Copyright (c) 2015-2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {COORDINATE_SYSTEM, PROJECTION_MODE} from '../../lib/constants';\nimport project from '../project/project';\nimport {Vector3, Matrix4} from '@math.gl/core';\nimport memoize from '../../utils/memoize';\nimport {pixelsToWorld} from '@math.gl/web-mercator';\n\nimport type {Texture2D} from '@luma.gl/webgl';\nimport type {ShaderModule, NumericArray} from '../../types/types';\nimport type Viewport from '../../viewports/viewport';\nimport type {ProjectUniforms} from '../project/viewport-uniforms';\n\nconst vs = `\nconst int max_lights = 2;\nuniform mat4 shadow_uViewProjectionMatrices[max_lights];\nuniform vec4 shadow_uProjectCenters[max_lights];\nuniform bool shadow_uDrawShadowMap;\nuniform bool shadow_uUseShadowMap;\nuniform int shadow_uLightId;\nuniform float shadow_uLightCount;\n\nvarying vec3 shadow_vPosition[max_lights];\n\nvec4 shadow_setVertexPosition(vec4 position_commonspace) {\n  if (shadow_uDrawShadowMap) {\n    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);\n  }\n  if (shadow_uUseShadowMap) {\n    for (int i = 0; i < max_lights; i++) {\n      if(i < int(shadow_uLightCount)) {\n        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);\n        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;\n      }\n    }\n  }\n  return gl_Position;\n}\n`;\n\nconst fs = `\nconst int max_lights = 2;\nuniform bool shadow_uDrawShadowMap;\nuniform bool shadow_uUseShadowMap;\nuniform sampler2D shadow_uShadowMap0;\nuniform sampler2D shadow_uShadowMap1;\nuniform vec4 shadow_uColor;\nuniform float shadow_uLightCount;\n\nvarying vec3 shadow_vPosition[max_lights];\n\nconst vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);\nconst vec4 bitUnpackShift = 1.0 / bitPackShift;\nconst vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);\n\nfloat shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {\n  vec4 rgbaDepth = texture2D(shadowMap, position.xy);\n\n  float z = dot(rgbaDepth, bitUnpackShift);\n  return smoothstep(0.001, 0.01, position.z - z);\n}\n\nvec4 shadow_filterShadowColor(vec4 color) {\n  if (shadow_uDrawShadowMap) {\n    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);\n    rgbaDepth -= rgbaDepth.gbaa * bitMask;\n    return rgbaDepth;\n  }\n  if (shadow_uUseShadowMap) {\n    float shadowAlpha = 0.0;\n    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);\n    if(shadow_uLightCount > 1.0) {\n      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);\n    }\n    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;\n    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);\n\n    return vec4(\n      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),\n      blendedAlpha\n    );\n  }\n  return color;\n}\n`;\n\nconst getMemoizedViewportCenterPosition = memoize(getViewportCenterPosition);\nconst getMemoizedViewProjectionMatrices = memoize(getViewProjectionMatrices);\n\nconst DEFAULT_SHADOW_COLOR = [0, 0, 0, 1.0];\nconst VECTOR_TO_POINT_MATRIX = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0];\n\ntype ShadowModuleSettings = {\n  viewport: Viewport;\n  shadowEnabled?: boolean;\n  drawToShadowMap?: boolean;\n  shadowMaps?: Texture2D[];\n  dummyShadowMap?: Texture2D;\n  shadowColor?: number[];\n  shadowMatrices?: Matrix4[];\n  shadowLightId?: number;\n};\n\nfunction screenToCommonSpace(xyz: number[], pixelUnprojectionMatrix: number[]): number[] {\n  const [x, y, z] = xyz;\n  const coord = pixelsToWorld([x, y, z], pixelUnprojectionMatrix);\n\n  if (Number.isFinite(z)) {\n    return coord;\n  }\n  return [coord[0], coord[1], 0];\n}\n\nfunction getViewportCenterPosition({\n  viewport,\n  center\n}: {\n  viewport: Viewport;\n  center: NumericArray;\n}): NumericArray {\n  return new Matrix4(viewport.viewProjectionMatrix).invert().transform(center);\n}\n\nfunction getViewProjectionMatrices({\n  viewport,\n  shadowMatrices\n}: {\n  viewport: Viewport;\n  shadowMatrices: Matrix4[];\n}): Matrix4[] {\n  const projectionMatrices: Matrix4[] = [];\n  const pixelUnprojectionMatrix = viewport.pixelUnprojectionMatrix;\n  const farZ = viewport.isGeospatial ? undefined : 1;\n  const corners = [\n    [0, 0, farZ], // top left ground\n    [viewport.width, 0, farZ], // top right ground\n    [0, viewport.height, farZ], // bottom left ground\n    [viewport.width, viewport.height, farZ], // bottom right ground\n    [0, 0, -1], // top left near\n    [viewport.width, 0, -1], // top right near\n    [0, viewport.height, -1], // bottom left near\n    [viewport.width, viewport.height, -1] // bottom right near\n  ].map(pixel =>\n    // @ts-expect-error z may be undefined\n    screenToCommonSpace(pixel, pixelUnprojectionMatrix)\n  );\n\n  for (const shadowMatrix of shadowMatrices) {\n    const viewMatrix = shadowMatrix.clone().translate(new Vector3(viewport.center).negate());\n    const positions = corners.map(corner => viewMatrix.transform(corner));\n    const projectionMatrix = new Matrix4().ortho({\n      left: Math.min(...positions.map(position => position[0])),\n      right: Math.max(...positions.map(position => position[0])),\n      bottom: Math.min(...positions.map(position => position[1])),\n      top: Math.max(...positions.map(position => position[1])),\n      near: Math.min(...positions.map(position => -position[2])),\n      far: Math.max(...positions.map(position => -position[2]))\n    });\n    projectionMatrices.push(projectionMatrix.multiplyRight(shadowMatrix));\n  }\n  return projectionMatrices;\n}\n\n/* eslint-disable camelcase */\nfunction createShadowUniforms(\n  opts: ShadowModuleSettings,\n  context: ProjectUniforms\n): Record<string, any> {\n  const {shadowEnabled = true} = opts;\n  if (!shadowEnabled || !opts.shadowMatrices || !opts.shadowMatrices.length) {\n    return {\n      shadow_uDrawShadowMap: false,\n      shadow_uUseShadowMap: false\n    };\n  }\n  const uniforms = {\n    shadow_uDrawShadowMap: Boolean(opts.drawToShadowMap),\n    shadow_uUseShadowMap: opts.shadowMaps ? opts.shadowMaps.length > 0 : false,\n    shadow_uColor: opts.shadowColor || DEFAULT_SHADOW_COLOR,\n    shadow_uLightId: opts.shadowLightId || 0,\n    shadow_uLightCount: opts.shadowMatrices.length\n  };\n\n  const center = getMemoizedViewportCenterPosition({\n    viewport: opts.viewport,\n    center: context.project_uCenter\n  });\n\n  const projectCenters: NumericArray[] = [];\n  const viewProjectionMatrices = getMemoizedViewProjectionMatrices({\n    shadowMatrices: opts.shadowMatrices,\n    viewport: opts.viewport\n  }).slice();\n\n  for (let i = 0; i < opts.shadowMatrices.length; i++) {\n    const viewProjectionMatrix = viewProjectionMatrices[i];\n    const viewProjectionMatrixCentered = viewProjectionMatrix\n      .clone()\n      .translate(new Vector3(opts.viewport.center).negate());\n\n    if (\n      context.project_uCoordinateSystem === COORDINATE_SYSTEM.LNGLAT &&\n      context.project_uProjectionMode === PROJECTION_MODE.WEB_MERCATOR\n    ) {\n      viewProjectionMatrices[i] = viewProjectionMatrixCentered;\n      projectCenters[i] = center;\n    } else {\n      viewProjectionMatrices[i] = viewProjectionMatrix\n        .clone()\n        .multiplyRight(VECTOR_TO_POINT_MATRIX);\n      projectCenters[i] = viewProjectionMatrixCentered.transform(center);\n    }\n  }\n\n  for (let i = 0; i < viewProjectionMatrices.length; i++) {\n    uniforms[`shadow_uViewProjectionMatrices[${i}]`] = viewProjectionMatrices[i];\n    uniforms[`shadow_uProjectCenters[${i}]`] = projectCenters[i];\n\n    if (opts.shadowMaps && opts.shadowMaps.length > 0) {\n      uniforms[`shadow_uShadowMap${i}`] = opts.shadowMaps[i];\n    } else {\n      uniforms[`shadow_uShadowMap${i}`] = opts.dummyShadowMap;\n    }\n  }\n  return uniforms;\n}\n\nexport default {\n  name: 'shadow',\n  dependencies: [project],\n  vs,\n  fs,\n  inject: {\n    'vs:DECKGL_FILTER_GL_POSITION': `\n    position = shadow_setVertexPosition(geometry.position);\n    `,\n    'fs:DECKGL_FILTER_COLOR': `\n    color = shadow_filterShadowColor(color);\n    `\n  },\n  getUniforms: (opts = {}, context = {}) => {\n    if (\n      'viewport' in opts &&\n      (opts.drawToShadowMap || (opts.shadowMaps && opts.shadowMaps.length > 0))\n    ) {\n      // @ts-expect-error if opts.viewport is defined, context should contain the project module's uniforms\n      return createShadowUniforms(opts, context);\n    }\n    return {};\n  }\n} as ShaderModule<ShadowModuleSettings>;\n"],"file":"shadow.js"}