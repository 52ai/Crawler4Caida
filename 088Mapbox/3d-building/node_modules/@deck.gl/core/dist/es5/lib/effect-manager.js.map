{"version":3,"sources":["../../../src/lib/effect-manager.ts"],"names":["DEFAULT_LIGHTING_EFFECT","LightingEffect","EffectManager","effects","_internalEffects","_needsRedraw","setEffects","props","length","opts","clearRedrawFlags","redraw","cleanup","slice","push","MaskEffect","some","effect"],"mappings":";;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;;;;;;;AAGA,IAAMA,uBAAuB,GAAG,IAAIC,uBAAJ,EAAhC;;IAEqBC,a;AAKnB,2BAAc;AAAA;AAAA;AAAA;AAAA;AACZ,SAAKC,OAAL,GAAe,EAAf;AACA,SAAKC,gBAAL,GAAwB,EAAxB;AACA,SAAKC,YAAL,GAAoB,gBAApB;AACA,SAAKC,UAAL;AACD;;;;WAED,kBAASC,KAAT,EAAgB;AACd,UAAI,aAAaA,KAAjB,EAAwB;AACtB,YAAIA,KAAK,CAACJ,OAAN,CAAcK,MAAd,KAAyB,KAAKL,OAAL,CAAaK,MAAtC,IAAgD,CAAC,0BAAUD,KAAK,CAACJ,OAAhB,EAAyB,KAAKA,OAA9B,CAArD,EAA6F;AAC3F,eAAKG,UAAL,CAAgBC,KAAK,CAACJ,OAAtB;AACA,eAAKE,YAAL,GAAoB,iBAApB;AACD;AACF;AACF;;;WAED,uBAA8D;AAAA,UAAlDI,IAAkD,uEAA3C;AAACC,QAAAA,gBAAgB,EAAE;AAAnB,OAA2C;AAC5D,UAAMC,MAAM,GAAG,KAAKN,YAApB;;AACA,UAAII,IAAI,CAACC,gBAAT,EAA2B;AACzB,aAAKL,YAAL,GAAoB,KAApB;AACD;;AACD,aAAOM,MAAP;AACD;;;WAED,sBAAa;AACX,aAAO,KAAKP,gBAAZ;AACD;;;WAED,oBAAW;AACT,WAAKQ,OAAL;AACD;;;WAGD,sBAAmC;AAAA,UAAxBT,OAAwB,uEAAJ,EAAI;AACjC,WAAKS,OAAL;AACA,WAAKT,OAAL,GAAeA,OAAf;AAEA,WAAKC,gBAAL,GAAwBD,OAAO,CAACU,KAAR,EAAxB;;AAEA,WAAKT,gBAAL,CAAsBU,IAAtB,CAA2B,IAAIC,mBAAJ,EAA3B;;AACA,UAAI,CAACZ,OAAO,CAACa,IAAR,CAAa,UAAAC,MAAM;AAAA,eAAIA,MAAM,YAAYhB,uBAAtB;AAAA,OAAnB,CAAL,EAA+D;AAC7D,aAAKG,gBAAL,CAAsBU,IAAtB,CAA2Bd,uBAA3B;AACD;AACF;;;WAED,mBAAU;AAAA,iDACa,KAAKG,OADlB;AAAA;;AAAA;AACR,4DAAmC;AAAA,cAAxBc,MAAwB;AACjCA,UAAAA,MAAM,CAACL,OAAP;AACD;AAHO;AAAA;AAAA;AAAA;AAAA;;AAAA,kDAKa,KAAKR,gBALlB;AAAA;;AAAA;AAKR,+DAA4C;AAAA,cAAjCa,OAAiC;;AAC1CA,UAAAA,OAAM,CAACL,OAAP;AACD;AAPO;AAAA;AAAA;AAAA;AAAA;;AAQR,WAAKT,OAAL,CAAaK,MAAb,GAAsB,CAAtB;AACA,WAAKJ,gBAAL,CAAsBI,MAAtB,GAA+B,CAA/B;AACD","sourcesContent":["import {deepEqual} from '../utils/deep-equal';\nimport LightingEffect from '../effects/lighting/lighting-effect';\nimport MaskEffect from '../effects/mask/mask-effect';\nimport type {Effect} from './effect';\n\nconst DEFAULT_LIGHTING_EFFECT = new LightingEffect();\n\nexport default class EffectManager {\n  effects: Effect[];\n  _internalEffects: Effect[];\n  _needsRedraw: false | string;\n\n  constructor() {\n    this.effects = [];\n    this._internalEffects = [];\n    this._needsRedraw = 'Initial render';\n    this.setEffects();\n  }\n\n  setProps(props) {\n    if ('effects' in props) {\n      if (props.effects.length !== this.effects.length || !deepEqual(props.effects, this.effects)) {\n        this.setEffects(props.effects);\n        this._needsRedraw = 'effects changed';\n      }\n    }\n  }\n\n  needsRedraw(opts = {clearRedrawFlags: false}): false | string {\n    const redraw = this._needsRedraw;\n    if (opts.clearRedrawFlags) {\n      this._needsRedraw = false;\n    }\n    return redraw;\n  }\n\n  getEffects() {\n    return this._internalEffects;\n  }\n\n  finalize() {\n    this.cleanup();\n  }\n\n  // Private\n  setEffects(effects: Effect[] = []) {\n    this.cleanup();\n    this.effects = effects;\n\n    this._internalEffects = effects.slice();\n    // Unique MaskEffect per EffectManager as GL context may be different\n    this._internalEffects.push(new MaskEffect());\n    if (!effects.some(effect => effect instanceof LightingEffect)) {\n      this._internalEffects.push(DEFAULT_LIGHTING_EFFECT);\n    }\n  }\n\n  cleanup() {\n    for (const effect of this.effects) {\n      effect.cleanup();\n    }\n\n    for (const effect of this._internalEffects) {\n      effect.cleanup();\n    }\n    this.effects.length = 0;\n    this._internalEffects.length = 0;\n  }\n}\n"],"file":"effect-manager.js"}