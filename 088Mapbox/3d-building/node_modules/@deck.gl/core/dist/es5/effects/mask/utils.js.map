{"version":3,"sources":["../../../../src/effects/mask/utils.ts"],"names":["getMaskBounds","layers","viewport","bounds","layer","subLayerBounds","getBounds","Math","min","max","viewportBounds","paddedBounds","_doubleBounds","getMaskViewport","width","height","padding","WebMercatorViewport","maxZoom","longitude","latitude","zoom","x","y","center","scale","OrthographicView","makeViewport","viewState","target","log2","size"],"mappings":"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","sourcesContent":["import OrthographicView from '../../views/orthographic-view';\nimport WebMercatorViewport from '../../viewports/web-mercator-viewport';\nimport {fitBounds} from '@math.gl/web-mercator';\n\nimport type Layer from '../../lib/layer';\nimport type Viewport from '../../viewports/viewport';\n\nexport type MaskBounds = [number, number, number, number];\n\n/*\n * Compute the bounds of the mask in world space, such that it covers an\n * area currently visible (extended by a buffer) or the area of the masking\n * data, whichever is smaller\n */\nexport function getMaskBounds({\n  layers,\n  viewport\n}: {\n  layers: Layer[];\n  viewport: Viewport;\n}): MaskBounds {\n  // Join the bounds of layer data\n  let bounds: MaskBounds | null = null;\n  for (const layer of layers) {\n    const subLayerBounds = layer.getBounds();\n    if (subLayerBounds) {\n      if (bounds) {\n        bounds[0] = Math.min(bounds[0], subLayerBounds[0][0]);\n        bounds[1] = Math.min(bounds[1], subLayerBounds[0][1]);\n        bounds[2] = Math.max(bounds[2], subLayerBounds[1][0]);\n        bounds[3] = Math.max(bounds[3], subLayerBounds[1][1]);\n      } else {\n        bounds = [\n          subLayerBounds[0][0],\n          subLayerBounds[0][1],\n          subLayerBounds[1][0],\n          subLayerBounds[1][1]\n        ];\n      }\n    }\n  }\n  const viewportBounds = viewport.getBounds();\n  if (!bounds) {\n    return viewportBounds;\n  }\n\n  // Expand viewport bounds by 2X. Heurestically chosen to avoid masking\n  // errors when mask is partially out of view\n  const paddedBounds = _doubleBounds(viewportBounds);\n\n  // When bounds of the mask are smaller than the viewport bounds simply use\n  // mask bounds, so as to maximize resolution & avoid mask rerenders\n  if (\n    bounds[2] - bounds[0] < paddedBounds[2] - paddedBounds[0] ||\n    bounds[3] - bounds[1] < paddedBounds[3] - paddedBounds[1]\n  ) {\n    return bounds;\n  }\n\n  // As viewport shrinks, to avoid pixelation along mask edges\n  // we need to reduce the bounds and only render the visible portion\n  // of the mask.\n  // We pad the viewport bounds to capture the section\n  // of the mask just outside the viewport to correctly maskByInstance.\n  // Intersect mask & padded viewport bounds\n  bounds[0] = Math.max(bounds[0], paddedBounds[0]);\n  bounds[1] = Math.max(bounds[1], paddedBounds[1]);\n  bounds[2] = Math.min(bounds[2], paddedBounds[2]);\n  bounds[3] = Math.min(bounds[3], paddedBounds[3]);\n  return bounds;\n}\n\n/*\n * Compute viewport to render the mask into, covering the given bounds\n */\nexport function getMaskViewport({\n  bounds,\n  viewport,\n  width,\n  height\n}: {\n  bounds: MaskBounds;\n  viewport: Viewport;\n  width: number;\n  height: number;\n}): Viewport | null {\n  if (bounds[2] <= bounds[0] || bounds[3] <= bounds[1]) {\n    return null;\n  }\n\n  // Single pixel border to prevent mask bleeding at edge of texture\n  const padding = 1;\n  width -= padding * 2;\n  height -= padding * 2;\n\n  if (viewport instanceof WebMercatorViewport) {\n    const {longitude, latitude, zoom} = fitBounds({\n      width,\n      height,\n      bounds: [\n        [bounds[0], bounds[1]],\n        [bounds[2], bounds[3]]\n      ],\n      maxZoom: 20\n    });\n    return new WebMercatorViewport({\n      longitude,\n      latitude,\n      zoom,\n      x: padding,\n      y: padding,\n      width,\n      height\n    });\n  }\n\n  const center = [(bounds[0] + bounds[2]) / 2, (bounds[1] + bounds[3]) / 2, 0];\n  const scale = Math.min(20, width / (bounds[2] - bounds[0]), height / (bounds[3] - bounds[1]));\n\n  return new OrthographicView({\n    x: padding,\n    y: padding\n  }).makeViewport({\n    width,\n    height,\n    viewState: {\n      target: center,\n      zoom: Math.log2(scale)\n    }\n  });\n}\n\nfunction _doubleBounds(bounds: MaskBounds): MaskBounds {\n  const size = {\n    x: bounds[2] - bounds[0],\n    y: bounds[3] - bounds[1]\n  };\n  const center = {\n    x: bounds[0] + 0.5 * size.x,\n    y: bounds[1] + 0.5 * size.y\n  };\n  return [center.x - size.x, center.y - size.y, center.x + size.x, center.y + size.y];\n}\n"],"file":"utils.js"}