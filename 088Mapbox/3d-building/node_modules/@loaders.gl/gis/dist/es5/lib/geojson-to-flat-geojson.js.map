{"version":3,"sources":["../../../src/lib/geojson-to-flat-geojson.ts"],"names":["geojsonToFlatGeojson","features","options","coordLength","fixRingWinding","map","feature","flattenFeature","flattenPoint","coordinates","data","indices","push","length","i","flattenLineString","c","flattenPolygon","areas","count","ringAreas","polygons","lineString","lineString2d","p","slice","area","flat","ccw","reverse","geometry","type","Error"],"mappings":"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","sourcesContent":["import {getPolygonSignedArea} from '@math.gl/polygon';\n\nimport {Feature, Position, FlatFeature} from '@loaders.gl/schema';\n\n/**\n * Options for `geojsonToFlatGeojson`\n */\nexport type GeojsonToFlatGeojsonOptions = {\n  coordLength: number;\n  fixRingWinding: boolean;\n};\n\n// Coordinates defining a Point\ntype PointCoordinates = Position;\n// Coordinates defining a LineString\ntype LineStringCoordinates = Position[];\n// Coordinates defining a Polygon\ntype PolygonCoordinates = Position[][];\n\n/**\n * Convert GeoJSON features to Flat GeoJSON features\n *\n * @param features\n * @param options\n * @returns an Array of Flat GeoJSON features\n */\nexport function geojsonToFlatGeojson(\n  features: Feature[],\n  options: GeojsonToFlatGeojsonOptions = {coordLength: 2, fixRingWinding: true}\n): FlatFeature[] {\n  return features.map((feature) => flattenFeature(feature, options));\n}\n\n/**\n * Helper function to copy Point values from `coordinates` into `data` & `indices`\n *\n * @param coordinates\n * @param data\n * @param indices\n * @param options\n */\nfunction flattenPoint(\n  coordinates: PointCoordinates,\n  data: number[],\n  indices: number[],\n  options: GeojsonToFlatGeojsonOptions\n) {\n  indices.push(data.length);\n  data.push(...coordinates);\n\n  // Pad up to coordLength\n  for (let i = coordinates.length; i < options.coordLength; i++) {\n    data.push(0);\n  }\n}\n\n/**\n * Helper function to copy LineString values from `coordinates` into `data` & `indices`\n *\n * @param coordinates\n * @param data\n * @param indices\n * @param options\n */\nfunction flattenLineString(\n  coordinates: LineStringCoordinates,\n  data: number[],\n  indices: number[],\n  options: GeojsonToFlatGeojsonOptions\n) {\n  indices.push(data.length);\n  for (const c of coordinates) {\n    data.push(...c);\n\n    // Pad up to coordLength\n    for (let i = c.length; i < options.coordLength; i++) {\n      data.push(0);\n    }\n  }\n}\n\n/**\n * Helper function to copy Polygon values from `coordinates` into `data` & `indices` & `areas`\n *\n * @param coordinates\n * @param data\n * @param indices\n * @param areas\n * @param options\n */\nfunction flattenPolygon(\n  coordinates: PolygonCoordinates,\n  data: number[],\n  indices: number[][],\n  areas: number[][],\n  options: GeojsonToFlatGeojsonOptions\n) {\n  let count = 0;\n  const ringAreas: number[] = [];\n  const polygons: number[] = [];\n  for (const lineString of coordinates) {\n    const lineString2d = lineString.map((p) => p.slice(0, 2));\n    let area = getPolygonSignedArea(lineString2d.flat());\n    const ccw = area < 0;\n\n    // Exterior ring must be CCW and interior rings CW\n    if (options.fixRingWinding && ((count === 0 && !ccw) || (count > 0 && ccw))) {\n      lineString.reverse();\n      area = -area;\n    }\n    ringAreas.push(area);\n    flattenLineString(lineString, data, polygons, options);\n    count++;\n  }\n\n  if (count > 0) {\n    areas.push(ringAreas);\n    indices.push(polygons);\n  }\n}\n\n/**\n * Flatten single GeoJSON feature into Flat GeoJSON\n *\n * @param feature\n * @param options\n * @returns A Flat GeoJSON feature\n */\nfunction flattenFeature(feature: Feature, options: GeojsonToFlatGeojsonOptions): FlatFeature {\n  const {geometry} = feature;\n  if (geometry.type === 'GeometryCollection') {\n    throw new Error('GeometryCollection type not supported');\n  }\n  const data = [];\n  const indices = [];\n  let areas;\n  let type;\n\n  switch (geometry.type) {\n    case 'Point':\n      type = 'Point';\n      flattenPoint(geometry.coordinates, data, indices, options);\n      break;\n    case 'MultiPoint':\n      type = 'Point';\n      geometry.coordinates.map((c) => flattenPoint(c, data, indices, options));\n      break;\n    case 'LineString':\n      type = 'LineString';\n      flattenLineString(geometry.coordinates, data, indices, options);\n      break;\n    case 'MultiLineString':\n      type = 'LineString';\n      geometry.coordinates.map((c) => flattenLineString(c, data, indices, options));\n      break;\n    case 'Polygon':\n      type = 'Polygon';\n      areas = [];\n      flattenPolygon(geometry.coordinates, data, indices, areas, options);\n      break;\n    case 'MultiPolygon':\n      type = 'Polygon';\n      areas = [];\n      geometry.coordinates.map((c) => flattenPolygon(c, data, indices, areas, options));\n      break;\n    default:\n      throw new Error(`Unknown type: ${type}`);\n  }\n\n  return {...feature, geometry: {type, indices, data, areas}};\n}\n"],"file":"geojson-to-flat-geojson.js"}