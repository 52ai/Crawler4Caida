{"version":3,"file":"timeline.js","names":["channelHandles","animationHandles","Timeline","time","channels","Map","animations","playing","lastEngineTime","props","delay","duration","Number","POSITIVE_INFINITY","rate","repeat","handle","channel","_setChannelTime","set","delete","animationHandle","animation","detachAnimation","get","undefined","Math","max","values","animationData","setTime","getTime","channelHandle","engineTime","offsetTime","totalDuration"],"sources":["../../../src/animation/timeline.js"],"sourcesContent":["let channelHandles = 1;\nlet animationHandles = 1;\n\nexport class Timeline {\n  constructor() {\n    this.time = 0;\n    this.channels = new Map();\n    this.animations = new Map();\n    this.playing = false;\n    this.lastEngineTime = -1;\n  }\n\n  addChannel(props) {\n    const {delay = 0, duration = Number.POSITIVE_INFINITY, rate = 1, repeat = 1} = props;\n\n    const handle = channelHandles++;\n    const channel = {\n      time: 0,\n      delay,\n      duration,\n      rate,\n      repeat\n    };\n    this._setChannelTime(channel, this.time);\n    this.channels.set(handle, channel);\n\n    return handle;\n  }\n\n  removeChannel(handle) {\n    this.channels.delete(handle);\n\n    for (const [animationHandle, animation] of this.animations) {\n      if (animation.channel === handle) {\n        this.detachAnimation(animationHandle);\n      }\n    }\n  }\n\n  isFinished(handle) {\n    const channel = this.channels.get(handle);\n    if (channel === undefined) {\n      return false;\n    }\n\n    return this.time >= channel.delay + channel.duration * channel.repeat;\n  }\n\n  getTime(handle) {\n    if (handle === undefined) {\n      return this.time;\n    }\n\n    const channel = this.channels.get(handle);\n\n    if (channel === undefined) {\n      return -1;\n    }\n\n    return channel.time;\n  }\n\n  setTime(time) {\n    this.time = Math.max(0, time);\n\n    const channels = this.channels.values();\n    for (const channel of channels) {\n      this._setChannelTime(channel, this.time);\n    }\n\n    const animations = this.animations.values();\n    for (const animationData of animations) {\n      const {animation, channel} = animationData;\n      animation.setTime(this.getTime(channel));\n    }\n  }\n\n  play() {\n    this.playing = true;\n  }\n\n  pause() {\n    this.playing = false;\n    this.lastEngineTime = -1;\n  }\n\n  reset() {\n    this.setTime(0);\n  }\n\n  attachAnimation(animation, channelHandle) {\n    const animationHandle = animationHandles++;\n\n    this.animations.set(animationHandle, {\n      animation,\n      channel: channelHandle\n    });\n\n    animation.setTime(this.getTime(channelHandle));\n\n    return animationHandle;\n  }\n\n  detachAnimation(handle) {\n    this.animations.delete(handle);\n  }\n\n  update(engineTime) {\n    if (this.playing) {\n      if (this.lastEngineTime === -1) {\n        this.lastEngineTime = engineTime;\n      }\n      this.setTime(this.time + (engineTime - this.lastEngineTime));\n      this.lastEngineTime = engineTime;\n    }\n  }\n\n  _setChannelTime(channel, time) {\n    const offsetTime = time - channel.delay;\n    const totalDuration = channel.duration * channel.repeat;\n    // Note(Tarek): Don't loop on final repeat.\n    if (offsetTime >= totalDuration) {\n      channel.time = channel.duration * channel.rate;\n    } else {\n      channel.time = Math.max(0, offsetTime) % channel.duration;\n      channel.time *= channel.rate;\n    }\n  }\n}\n"],"mappings":"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"}