{"version":3,"file":"buffer-transform.js","names":["BufferTransform","gl","props","currentIndex","feedbackMap","varyings","bindings","resources","_initialize","Object","seal","opts","binding","_setupTransformFeedback","length","assign","sourceBuffers","transformFeedback","attributes","_getNextIndex","_setupBuffers","varyingName","feedbackBuffers","bufferOrParams","Buffer","buffer","options","getBuffer","getData","name","delete","keys","assert","isWebGL2","sourceName","feedbackName","bufferName","bufferOrRef","sourceBuffer","byteLength","usage","accessor","_createNewBuffer","_getFeedbackBuffers","_updateBindings","model","program","TransformFeedback","buffers","_updateBinding","_swapBuffers","nextIndex","setBuffers","srcName","dstName"],"sources":["../../../src/transform/buffer-transform.js"],"sourcesContent":["import {isWebGL2} from '@luma.gl/gltools';\nimport {Buffer, TransformFeedback} from '@luma.gl/webgl';\nimport {assert} from '@luma.gl/webgl';\n\nexport default class BufferTransform {\n  constructor(gl, props = {}) {\n    this.gl = gl;\n    this.currentIndex = 0;\n    this.feedbackMap = {};\n    this.varyings = null; // varyings array\n    this.bindings = []; // each element is an object : {sourceBuffers, feedbackBuffers, transformFeedback}\n\n    this.resources = {}; // resources to be deleted\n\n    this._initialize(props);\n    Object.seal(this);\n  }\n\n  setupResources(opts) {\n    for (const binding of this.bindings) {\n      this._setupTransformFeedback(binding, opts);\n    }\n  }\n\n  updateModelProps(props = {}) {\n    const {varyings} = this;\n    if (varyings.length > 0) {\n      props = Object.assign({}, props, {varyings});\n    }\n    return props;\n  }\n\n  getDrawOptions(opts = {}) {\n    const binding = this.bindings[this.currentIndex];\n    const {sourceBuffers, transformFeedback} = binding;\n    const attributes = Object.assign({}, sourceBuffers, opts.attributes);\n\n    return {attributes, transformFeedback};\n  }\n\n  swap() {\n    if (this.feedbackMap) {\n      this.currentIndex = this._getNextIndex();\n      return true;\n    }\n    return false;\n  }\n\n  // update source and/or feedbackBuffers\n  update(opts = {}) {\n    this._setupBuffers(opts);\n  }\n\n  // returns current feedbackBuffer of given name\n  getBuffer(varyingName) {\n    const {feedbackBuffers} = this.bindings[this.currentIndex];\n    const bufferOrParams = varyingName ? feedbackBuffers[varyingName] : null;\n    if (!bufferOrParams) {\n      return null;\n    }\n    return bufferOrParams instanceof Buffer ? bufferOrParams : bufferOrParams.buffer;\n  }\n\n  getData(options = {}) {\n    const {varyingName} = options;\n    const buffer = this.getBuffer(varyingName);\n    if (buffer) {\n      return buffer.getData();\n    }\n    return null;\n  }\n\n  // Delete owned resources.\n  delete() {\n    for (const name in this.resources) {\n      this.resources[name].delete();\n    }\n  }\n\n  // Private\n\n  _initialize(props = {}) {\n    this._setupBuffers(props);\n    this.varyings = props.varyings || Object.keys(this.bindings[this.currentIndex].feedbackBuffers);\n    if (this.varyings.length > 0) {\n      // if writting to buffers make sure it is WebGL2\n      assert(isWebGL2(this.gl));\n    }\n  }\n\n  // auto create feedback buffers if requested\n  _getFeedbackBuffers(props) {\n    const {sourceBuffers = {}} = props;\n    const feedbackBuffers = {};\n    if (this.bindings[this.currentIndex]) {\n      // this gurantees a partial feedback buffer set doesn't update\n      // previously set buffers during auto creation mode.\n      Object.assign(feedbackBuffers, this.bindings[this.currentIndex].feedbackBuffers);\n    }\n    if (this.feedbackMap) {\n      // feedbackMap is defined as sourceBuffer as key and feedbackBuffer name as object\n      for (const sourceName in this.feedbackMap) {\n        const feedbackName = this.feedbackMap[sourceName];\n        if (sourceName in sourceBuffers) {\n          feedbackBuffers[feedbackName] = sourceName;\n        }\n      }\n    }\n    Object.assign(feedbackBuffers, props.feedbackBuffers);\n    for (const bufferName in feedbackBuffers) {\n      const bufferOrRef = feedbackBuffers[bufferName];\n      if (typeof bufferOrRef === 'string') {\n        // Create new buffer with same layout and settings as source buffer\n        const sourceBuffer = sourceBuffers[bufferOrRef];\n        const {byteLength, usage, accessor} = sourceBuffer;\n        feedbackBuffers[bufferName] = this._createNewBuffer(bufferName, {\n          byteLength,\n          usage,\n          accessor\n        });\n      }\n    }\n\n    return feedbackBuffers;\n  }\n\n  _setupBuffers(props = {}) {\n    const {sourceBuffers = null} = props;\n    Object.assign(this.feedbackMap, props.feedbackMap);\n    const feedbackBuffers = this._getFeedbackBuffers(props);\n    this._updateBindings({sourceBuffers, feedbackBuffers});\n  }\n\n  _setupTransformFeedback(binding, {model}) {\n    const {program} = model;\n    binding.transformFeedback = new TransformFeedback(this.gl, {\n      program,\n      buffers: binding.feedbackBuffers\n    });\n  }\n\n  _updateBindings(opts) {\n    this.bindings[this.currentIndex] = this._updateBinding(this.bindings[this.currentIndex], opts);\n    if (this.feedbackMap) {\n      const {sourceBuffers, feedbackBuffers} = this._swapBuffers(this.bindings[this.currentIndex]);\n      const nextIndex = this._getNextIndex();\n      this.bindings[nextIndex] = this._updateBinding(this.bindings[nextIndex], {\n        sourceBuffers,\n        feedbackBuffers\n      });\n    }\n  }\n\n  _updateBinding(binding, opts) {\n    if (!binding) {\n      return {\n        sourceBuffers: Object.assign({}, opts.sourceBuffers),\n        feedbackBuffers: Object.assign({}, opts.feedbackBuffers)\n      };\n    }\n    Object.assign(binding.sourceBuffers, opts.sourceBuffers);\n    Object.assign(binding.feedbackBuffers, opts.feedbackBuffers);\n    if (binding.transformFeedback) {\n      binding.transformFeedback.setBuffers(binding.feedbackBuffers);\n    }\n    return binding;\n  }\n\n  _swapBuffers(opts) {\n    if (!this.feedbackMap) {\n      return null;\n    }\n    const sourceBuffers = Object.assign({}, opts.sourceBuffers);\n    const feedbackBuffers = Object.assign({}, opts.feedbackBuffers);\n    for (const srcName in this.feedbackMap) {\n      const dstName = this.feedbackMap[srcName];\n      sourceBuffers[srcName] = opts.feedbackBuffers[dstName];\n      feedbackBuffers[dstName] = opts.sourceBuffers[srcName];\n\n      // make sure the new destination buffer is a Buffer object\n      assert(feedbackBuffers[dstName] instanceof Buffer);\n    }\n    return {sourceBuffers, feedbackBuffers};\n  }\n\n  // Create a buffer and add to list of buffers to be deleted.\n  _createNewBuffer(name, opts) {\n    const buffer = new Buffer(this.gl, opts);\n    if (this.resources[name]) {\n      this.resources[name].delete();\n    }\n    this.resources[name] = buffer;\n    return buffer;\n  }\n\n  _getNextIndex() {\n    return (this.currentIndex + 1) % 2;\n  }\n}\n"],"mappings":"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"}