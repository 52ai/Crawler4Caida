{"version":3,"file":"gltf-instantiator.js","names":["ATTRIBUTE_TYPE_TO_COMPONENTS","SCALAR","VEC2","VEC3","VEC4","MAT2","MAT3","MAT4","DEFAULT_OPTIONS","modelOptions","pbrDebug","imageBasedLightingEnvironment","lights","useTangents","GLTFInstantiator","gl","options","Object","assign","gltf","scenes","map","scene","createScene","Array","isArray","animations","GLTFAnimator","gltfScene","gltfNodes","nodes","node","createNode","GroupNode","id","name","children","gltfNode","_node","gltfChildren","child","mesh","push","createMesh","matrix","setMatrix","identity","translation","translate","rotation","rotationMatrix","Matrix4","fromQuaternion","multiplyRight","scale","gltfMesh","_mesh","gltfPrimitives","primitives","gltfPrimitive","i","createPrimitive","attributes","log","warn","createGLTFModel","drawMode","mode","vertexCount","indices","count","getVertexCount","createAttributes","material","loadedAttributes","keys","forEach","attrName","createAccessor","createBuffer","ARRAY_BUFFER","ELEMENT_ARRAY_BUFFER","info","generated","attribute","target","bufferView","lumaBuffers","Buffer","data","value","accessor","buffer","Accessor","offset","byteOffset","stride","byteStride","type","componentType","size","gltfSampler"],"sources":["../../../src/gltf/gltf-instantiator.js"],"sourcesContent":["import {Matrix4} from '@math.gl/core';\nimport {Buffer, Accessor, log} from '@luma.gl/webgl';\nimport GroupNode from '../scenegraph/group-node';\n\nimport GLTFAnimator from './gltf-animator';\nimport createGLTFModel from './create-gltf-model';\n\n// TODO: import {ATTRIBUTE_TYPE_TO_COMPONENTS} from '@loaders.gl/gltf';\nconst ATTRIBUTE_TYPE_TO_COMPONENTS = {\n  SCALAR: 1,\n  VEC2: 2,\n  VEC3: 3,\n  VEC4: 4,\n  MAT2: 4,\n  MAT3: 9,\n  MAT4: 16\n};\n\nconst DEFAULT_OPTIONS = {\n  modelOptions: {},\n  pbrDebug: false,\n  imageBasedLightingEnvironment: null,\n  lights: true,\n  useTangents: false\n};\n\n// GLTF instantiator for luma.gl\n// Walks the parsed and resolved glTF structure and builds a luma.gl scenegraph\nexport default class GLTFInstantiator {\n  constructor(gl, options = {}) {\n    this.gl = gl;\n    this.options = Object.assign({}, DEFAULT_OPTIONS, options);\n  }\n\n  instantiate(gltf) {\n    this.gltf = gltf;\n    const scenes = (gltf.scenes || []).map(scene => this.createScene(scene));\n    return scenes;\n  }\n\n  createAnimator() {\n    if (Array.isArray(this.gltf.animations)) {\n      return new GLTFAnimator(this.gltf);\n    }\n\n    return null;\n  }\n\n  createScene(gltfScene) {\n    const gltfNodes = gltfScene.nodes || [];\n    const nodes = gltfNodes.map(node => this.createNode(node));\n    const scene = new GroupNode({\n      id: gltfScene.name || gltfScene.id,\n      children: nodes\n    });\n    return scene;\n  }\n\n  createNode(gltfNode) {\n    if (!gltfNode._node) {\n      const gltfChildren = gltfNode.children || [];\n      const children = gltfChildren.map(child => this.createNode(child));\n\n      // Node can have children nodes and meshes at the same time\n      if (gltfNode.mesh) {\n        children.push(this.createMesh(gltfNode.mesh));\n      }\n\n      const node = new GroupNode({\n        id: gltfNode.name || gltfNode.id,\n        children\n      });\n\n      if (gltfNode.matrix) {\n        node.setMatrix(gltfNode.matrix);\n      } else {\n        node.matrix.identity();\n\n        if (gltfNode.translation) {\n          node.matrix.translate(gltfNode.translation);\n        }\n\n        if (gltfNode.rotation) {\n          const rotationMatrix = new Matrix4().fromQuaternion(gltfNode.rotation);\n          node.matrix.multiplyRight(rotationMatrix);\n        }\n\n        if (gltfNode.scale) {\n          node.matrix.scale(gltfNode.scale);\n        }\n      }\n      gltfNode._node = node;\n    }\n\n    return gltfNode._node;\n  }\n\n  createMesh(gltfMesh) {\n    // TODO: avoid changing the gltf\n    if (!gltfMesh._mesh) {\n      const gltfPrimitives = gltfMesh.primitives || [];\n      const primitives = gltfPrimitives.map((gltfPrimitive, i) =>\n        this.createPrimitive(gltfPrimitive, i, gltfMesh)\n      );\n      const mesh = new GroupNode({\n        id: gltfMesh.name || gltfMesh.id,\n        children: primitives\n      });\n      gltfMesh._mesh = mesh;\n    }\n\n    return gltfMesh._mesh;\n  }\n\n  getVertexCount(attributes) {\n    // TODO: implement this\n    log.warn('getVertexCount() not found')();\n  }\n\n  createPrimitive(gltfPrimitive, i, gltfMesh) {\n    return createGLTFModel(\n      this.gl,\n      Object.assign(\n        {\n          id: gltfPrimitive.name || `${gltfMesh.name || gltfMesh.id}-primitive-${i}`,\n          drawMode: gltfPrimitive.mode || 4,\n          vertexCount: gltfPrimitive.indices\n            ? gltfPrimitive.indices.count\n            : this.getVertexCount(gltfPrimitive.attributes),\n          attributes: this.createAttributes(gltfPrimitive.attributes, gltfPrimitive.indices),\n          material: gltfPrimitive.material\n        },\n        this.options\n      )\n    );\n  }\n\n  createAttributes(attributes, indices) {\n    const loadedAttributes = {};\n\n    Object.keys(attributes).forEach(attrName => {\n      loadedAttributes[attrName] = this.createAccessor(\n        attributes[attrName],\n        this.createBuffer(attributes[attrName], this.gl.ARRAY_BUFFER)\n      );\n    });\n\n    if (indices) {\n      loadedAttributes.indices = this.createAccessor(\n        indices,\n        this.createBuffer(indices, this.gl.ELEMENT_ARRAY_BUFFER)\n      );\n    }\n\n    log.info(4, 'glTF Attributes', {attributes, indices, generated: loadedAttributes})();\n\n    return loadedAttributes;\n  }\n\n  createBuffer(attribute, target) {\n    if (!attribute.bufferView) {\n      // Draco decoded files do not have a bufferView\n      attribute.bufferView = {};\n    }\n\n    const {bufferView} = attribute;\n    if (!bufferView.lumaBuffers) {\n      bufferView.lumaBuffers = {};\n    }\n\n    if (!bufferView.lumaBuffers[target]) {\n      bufferView.lumaBuffers[target] = new Buffer(this.gl, {\n        id: `from-${bufferView.id}`,\n        // Draco decoded files have attribute.value\n        data: bufferView.data || attribute.value,\n        target\n      });\n    }\n\n    return bufferView.lumaBuffers[target];\n  }\n\n  createAccessor(accessor, buffer) {\n    return new Accessor({\n      buffer,\n      offset: accessor.byteOffset || 0,\n      stride: accessor.bufferView.byteStride || 0,\n      type: accessor.componentType,\n      size: ATTRIBUTE_TYPE_TO_COMPONENTS[accessor.type]\n    });\n  }\n\n  // TODO - create sampler in WebGL2\n  createSampler(gltfSampler) {\n    return gltfSampler;\n  }\n\n  // Helper methods (move to GLTFLoader.resolve...?)\n\n  needsPOT() {\n    // Has a wrapping mode (either wrapS or wrapT) equal to REPEAT or MIRRORED_REPEAT, or\n    // Has a minification filter (minFilter) that uses mipmapping\n    // (NEAREST_MIPMAP_NEAREST, NEAREST_MIPMAP_LINEAR,\n    // LINEAR_MIPMAP_NEAREST, or LINEAR_MIPMAP_LINEAR).\n    return false;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;AAAA;;AACA;;AACA;;AAEA;;AACA;;AAGA,IAAMA,4BAA4B,GAAG;EACnCC,MAAM,EAAE,CAD2B;EAEnCC,IAAI,EAAE,CAF6B;EAGnCC,IAAI,EAAE,CAH6B;EAInCC,IAAI,EAAE,CAJ6B;EAKnCC,IAAI,EAAE,CAL6B;EAMnCC,IAAI,EAAE,CAN6B;EAOnCC,IAAI,EAAE;AAP6B,CAArC;AAUA,IAAMC,eAAe,GAAG;EACtBC,YAAY,EAAE,EADQ;EAEtBC,QAAQ,EAAE,KAFY;EAGtBC,6BAA6B,EAAE,IAHT;EAItBC,MAAM,EAAE,IAJc;EAKtBC,WAAW,EAAE;AALS,CAAxB;;IAUqBC,gB;EACnB,0BAAYC,EAAZ,EAA8B;IAAA,IAAdC,OAAc,uEAAJ,EAAI;IAAA;IAC5B,KAAKD,EAAL,GAAUA,EAAV;IACA,KAAKC,OAAL,GAAeC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBV,eAAlB,EAAmCQ,OAAnC,CAAf;EACD;;;;WAED,qBAAYG,IAAZ,EAAkB;MAAA;;MAChB,KAAKA,IAAL,GAAYA,IAAZ;MACA,IAAMC,MAAM,GAAG,CAACD,IAAI,CAACC,MAAL,IAAe,EAAhB,EAAoBC,GAApB,CAAwB,UAAAC,KAAK;QAAA,OAAI,KAAI,CAACC,WAAL,CAAiBD,KAAjB,CAAJ;MAAA,CAA7B,CAAf;MACA,OAAOF,MAAP;IACD;;;WAED,0BAAiB;MACf,IAAII,KAAK,CAACC,OAAN,CAAc,KAAKN,IAAL,CAAUO,UAAxB,CAAJ,EAAyC;QACvC,OAAO,IAAIC,qBAAJ,CAAiB,KAAKR,IAAtB,CAAP;MACD;;MAED,OAAO,IAAP;IACD;;;WAED,qBAAYS,SAAZ,EAAuB;MAAA;;MACrB,IAAMC,SAAS,GAAGD,SAAS,CAACE,KAAV,IAAmB,EAArC;MACA,IAAMA,KAAK,GAAGD,SAAS,CAACR,GAAV,CAAc,UAAAU,IAAI;QAAA,OAAI,MAAI,CAACC,UAAL,CAAgBD,IAAhB,CAAJ;MAAA,CAAlB,CAAd;MACA,IAAMT,KAAK,GAAG,IAAIW,kBAAJ,CAAc;QAC1BC,EAAE,EAAEN,SAAS,CAACO,IAAV,IAAkBP,SAAS,CAACM,EADN;QAE1BE,QAAQ,EAAEN;MAFgB,CAAd,CAAd;MAIA,OAAOR,KAAP;IACD;;;WAED,oBAAWe,QAAX,EAAqB;MAAA;;MACnB,IAAI,CAACA,QAAQ,CAACC,KAAd,EAAqB;QACnB,IAAMC,YAAY,GAAGF,QAAQ,CAACD,QAAT,IAAqB,EAA1C;QACA,IAAMA,QAAQ,GAAGG,YAAY,CAAClB,GAAb,CAAiB,UAAAmB,KAAK;UAAA,OAAI,MAAI,CAACR,UAAL,CAAgBQ,KAAhB,CAAJ;QAAA,CAAtB,CAAjB;;QAGA,IAAIH,QAAQ,CAACI,IAAb,EAAmB;UACjBL,QAAQ,CAACM,IAAT,CAAc,KAAKC,UAAL,CAAgBN,QAAQ,CAACI,IAAzB,CAAd;QACD;;QAED,IAAMV,IAAI,GAAG,IAAIE,kBAAJ,CAAc;UACzBC,EAAE,EAAEG,QAAQ,CAACF,IAAT,IAAiBE,QAAQ,CAACH,EADL;UAEzBE,QAAQ,EAARA;QAFyB,CAAd,CAAb;;QAKA,IAAIC,QAAQ,CAACO,MAAb,EAAqB;UACnBb,IAAI,CAACc,SAAL,CAAeR,QAAQ,CAACO,MAAxB;QACD,CAFD,MAEO;UACLb,IAAI,CAACa,MAAL,CAAYE,QAAZ;;UAEA,IAAIT,QAAQ,CAACU,WAAb,EAA0B;YACxBhB,IAAI,CAACa,MAAL,CAAYI,SAAZ,CAAsBX,QAAQ,CAACU,WAA/B;UACD;;UAED,IAAIV,QAAQ,CAACY,QAAb,EAAuB;YACrB,IAAMC,cAAc,GAAG,IAAIC,aAAJ,GAAcC,cAAd,CAA6Bf,QAAQ,CAACY,QAAtC,CAAvB;YACAlB,IAAI,CAACa,MAAL,CAAYS,aAAZ,CAA0BH,cAA1B;UACD;;UAED,IAAIb,QAAQ,CAACiB,KAAb,EAAoB;YAClBvB,IAAI,CAACa,MAAL,CAAYU,KAAZ,CAAkBjB,QAAQ,CAACiB,KAA3B;UACD;QACF;;QACDjB,QAAQ,CAACC,KAAT,GAAiBP,IAAjB;MACD;;MAED,OAAOM,QAAQ,CAACC,KAAhB;IACD;;;WAED,oBAAWiB,QAAX,EAAqB;MAAA;;MAEnB,IAAI,CAACA,QAAQ,CAACC,KAAd,EAAqB;QACnB,IAAMC,cAAc,GAAGF,QAAQ,CAACG,UAAT,IAAuB,EAA9C;QACA,IAAMA,UAAU,GAAGD,cAAc,CAACpC,GAAf,CAAmB,UAACsC,aAAD,EAAgBC,CAAhB;UAAA,OACpC,MAAI,CAACC,eAAL,CAAqBF,aAArB,EAAoCC,CAApC,EAAuCL,QAAvC,CADoC;QAAA,CAAnB,CAAnB;QAGA,IAAMd,IAAI,GAAG,IAAIR,kBAAJ,CAAc;UACzBC,EAAE,EAAEqB,QAAQ,CAACpB,IAAT,IAAiBoB,QAAQ,CAACrB,EADL;UAEzBE,QAAQ,EAAEsB;QAFe,CAAd,CAAb;QAIAH,QAAQ,CAACC,KAAT,GAAiBf,IAAjB;MACD;;MAED,OAAOc,QAAQ,CAACC,KAAhB;IACD;;;WAED,wBAAeM,UAAf,EAA2B;MAEzBC,UAAA,CAAIC,IAAJ,CAAS,4BAAT;IACD;;;WAED,yBAAgBL,aAAhB,EAA+BC,CAA/B,EAAkCL,QAAlC,EAA4C;MAC1C,OAAO,IAAAU,wBAAA,EACL,KAAKlD,EADA,EAELE,MAAM,CAACC,MAAP,CACE;QACEgB,EAAE,EAAEyB,aAAa,CAACxB,IAAd,cAAyBoB,QAAQ,CAACpB,IAAT,IAAiBoB,QAAQ,CAACrB,EAAnD,wBAAmE0B,CAAnE,CADN;QAEEM,QAAQ,EAAEP,aAAa,CAACQ,IAAd,IAAsB,CAFlC;QAGEC,WAAW,EAAET,aAAa,CAACU,OAAd,GACTV,aAAa,CAACU,OAAd,CAAsBC,KADb,GAET,KAAKC,cAAL,CAAoBZ,aAAa,CAACG,UAAlC,CALN;QAMEA,UAAU,EAAE,KAAKU,gBAAL,CAAsBb,aAAa,CAACG,UAApC,EAAgDH,aAAa,CAACU,OAA9D,CANd;QAOEI,QAAQ,EAAEd,aAAa,CAACc;MAP1B,CADF,EAUE,KAAKzD,OAVP,CAFK,CAAP;IAeD;;;WAED,0BAAiB8C,UAAjB,EAA6BO,OAA7B,EAAsC;MAAA;;MACpC,IAAMK,gBAAgB,GAAG,EAAzB;MAEAzD,MAAM,CAAC0D,IAAP,CAAYb,UAAZ,EAAwBc,OAAxB,CAAgC,UAAAC,QAAQ,EAAI;QAC1CH,gBAAgB,CAACG,QAAD,CAAhB,GAA6B,MAAI,CAACC,cAAL,CAC3BhB,UAAU,CAACe,QAAD,CADiB,EAE3B,MAAI,CAACE,YAAL,CAAkBjB,UAAU,CAACe,QAAD,CAA5B,EAAwC,MAAI,CAAC9D,EAAL,CAAQiE,YAAhD,CAF2B,CAA7B;MAID,CALD;;MAOA,IAAIX,OAAJ,EAAa;QACXK,gBAAgB,CAACL,OAAjB,GAA2B,KAAKS,cAAL,CACzBT,OADyB,EAEzB,KAAKU,YAAL,CAAkBV,OAAlB,EAA2B,KAAKtD,EAAL,CAAQkE,oBAAnC,CAFyB,CAA3B;MAID;;MAEDlB,UAAA,CAAImB,IAAJ,CAAS,CAAT,EAAY,iBAAZ,EAA+B;QAACpB,UAAU,EAAVA,UAAD;QAAaO,OAAO,EAAPA,OAAb;QAAsBc,SAAS,EAAET;MAAjC,CAA/B;;MAEA,OAAOA,gBAAP;IACD;;;WAED,sBAAaU,SAAb,EAAwBC,MAAxB,EAAgC;MAC9B,IAAI,CAACD,SAAS,CAACE,UAAf,EAA2B;QAEzBF,SAAS,CAACE,UAAV,GAAuB,EAAvB;MACD;;MAED,IAAOA,UAAP,GAAqBF,SAArB,CAAOE,UAAP;;MACA,IAAI,CAACA,UAAU,CAACC,WAAhB,EAA6B;QAC3BD,UAAU,CAACC,WAAX,GAAyB,EAAzB;MACD;;MAED,IAAI,CAACD,UAAU,CAACC,WAAX,CAAuBF,MAAvB,CAAL,EAAqC;QACnCC,UAAU,CAACC,WAAX,CAAuBF,MAAvB,IAAiC,IAAIG,aAAJ,CAAW,KAAKzE,EAAhB,EAAoB;UACnDmB,EAAE,iBAAUoD,UAAU,CAACpD,EAArB,CADiD;UAGnDuD,IAAI,EAAEH,UAAU,CAACG,IAAX,IAAmBL,SAAS,CAACM,KAHgB;UAInDL,MAAM,EAANA;QAJmD,CAApB,CAAjC;MAMD;;MAED,OAAOC,UAAU,CAACC,WAAX,CAAuBF,MAAvB,CAAP;IACD;;;WAED,wBAAeM,QAAf,EAAyBC,MAAzB,EAAiC;MAC/B,OAAO,IAAIC,eAAJ,CAAa;QAClBD,MAAM,EAANA,MADkB;QAElBE,MAAM,EAAEH,QAAQ,CAACI,UAAT,IAAuB,CAFb;QAGlBC,MAAM,EAAEL,QAAQ,CAACL,UAAT,CAAoBW,UAApB,IAAkC,CAHxB;QAIlBC,IAAI,EAAEP,QAAQ,CAACQ,aAJG;QAKlBC,IAAI,EAAEpG,4BAA4B,CAAC2F,QAAQ,CAACO,IAAV;MALhB,CAAb,CAAP;IAOD;;;WAGD,uBAAcG,WAAd,EAA2B;MACzB,OAAOA,WAAP;IACD;;;WAID,oBAAW;MAKT,OAAO,KAAP;IACD"}