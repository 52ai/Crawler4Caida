{"version":3,"file":"transform-feedback.js","names":["TransformFeedback","gl","props","assertWebGL2Context","initialize","stubRemovedMethods","Object","seal","buffers","unused","configuration","bindOnUse","isObjectEmpty","bind","_unbindBuffers","setProps","program","setBuffers","bufferName","setBuffer","locationOrName","bufferOrParams","location","_getVaryingIndex","_getBufferParams","buffer","byteSize","byteOffset","log","warn","id","_bindBuffer","primitiveMode","bindTransformFeedback","handle","_bindBuffers","beginTransformFeedback","endTransformFeedback","Buffer","undefined","byteLength","getVaryingInfo","Number","isFinite","bufferIndex","index","bindBufferBase","bindBufferRange","createTransformFeedback","deleteTransformFeedback","isWebGL2","Resource","Symbol","toStringTag"],"sources":["../../../src/classes/transform-feedback.js"],"sourcesContent":["import GL from '@luma.gl/constants';\nimport {isWebGL2, assertWebGL2Context, log} from '@luma.gl/gltools';\nimport Resource from './resource';\nimport Buffer from './buffer';\nimport {isObjectEmpty} from '../utils/utils';\n\n// NOTE: The `bindOnUse` flag is a major workaround:\n// See https://github.com/KhronosGroup/WebGL/issues/2346\n\nexport default class TransformFeedback extends Resource {\n  // eslint-disable-next-line accessor-pairs\n  get [Symbol.toStringTag]() {\n    return 'TransformFeedback';\n  }\n  static isSupported(gl) {\n    return isWebGL2(gl);\n  }\n\n  constructor(gl, props = {}) {\n    assertWebGL2Context(gl);\n    super(gl, props);\n\n    this.initialize(props);\n    this.stubRemovedMethods('TransformFeedback', 'v6.0', ['pause', 'resume']);\n    Object.seal(this);\n  }\n\n  initialize(props = {}) {\n    this.buffers = {};\n    this.unused = {};\n    this.configuration = null;\n    this.bindOnUse = true;\n\n    // Unbind any currently bound buffers\n    if (!isObjectEmpty(this.buffers)) {\n      this.bind(() => this._unbindBuffers());\n    }\n\n    this.setProps(props);\n    return this;\n  }\n\n  setProps(props) {\n    if ('program' in props) {\n      this.configuration = props.program && props.program.configuration;\n    }\n    if ('configuration' in props) {\n      this.configuration = props.configuration;\n    }\n    if ('bindOnUse' in props) {\n      props = props.bindOnUse;\n    }\n    if ('buffers' in props) {\n      this.setBuffers(props.buffers);\n    }\n  }\n\n  setBuffers(buffers = {}) {\n    this.bind(() => {\n      for (const bufferName in buffers) {\n        this.setBuffer(bufferName, buffers[bufferName]);\n      }\n    });\n    return this;\n  }\n\n  setBuffer(locationOrName, bufferOrParams) {\n    const location = this._getVaryingIndex(locationOrName);\n    const {buffer, byteSize, byteOffset} = this._getBufferParams(bufferOrParams);\n\n    if (location < 0) {\n      this.unused[locationOrName] = buffer;\n      log.warn(`${this.id} unused varying buffer ${locationOrName}`)();\n      return this;\n    }\n\n    this.buffers[location] = bufferOrParams;\n\n    // Need to avoid chrome bug where buffer that is already bound to a different target\n    // cannot be bound to 'TRANSFORM_FEEDBACK_BUFFER' target.\n    if (!this.bindOnUse) {\n      this._bindBuffer(location, buffer, byteOffset, byteSize);\n    }\n\n    return this;\n  }\n\n  begin(primitiveMode = GL.POINTS) {\n    // @ts-ignore\n    this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, this.handle);\n    this._bindBuffers();\n    // @ts-ignore\n    this.gl.beginTransformFeedback(primitiveMode);\n    return this;\n  }\n\n  end() {\n    // @ts-ignore\n    this.gl.endTransformFeedback();\n    this._unbindBuffers();\n    // @ts-ignore\n    this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, null);\n    return this;\n  }\n\n  // PRIVATE METHODS\n\n  _getBufferParams(bufferOrParams) {\n    let byteOffset;\n    let byteSize;\n    let buffer;\n    if (bufferOrParams instanceof Buffer === false) {\n      buffer = bufferOrParams.buffer;\n      byteSize = bufferOrParams.byteSize;\n      byteOffset = bufferOrParams.byteOffset;\n    } else {\n      buffer = bufferOrParams;\n    }\n    // to use bindBufferRange, either offset or size must be specified, use default value for the other.\n    if (byteOffset !== undefined || byteSize !== undefined) {\n      byteOffset = byteOffset || 0;\n      byteSize = byteSize || buffer.byteLength - byteOffset;\n    }\n    return {buffer, byteOffset, byteSize};\n  }\n\n  _getVaryingInfo(locationOrName) {\n    return this.configuration && this.configuration.getVaryingInfo(locationOrName);\n  }\n\n  _getVaryingIndex(locationOrName) {\n    if (this.configuration) {\n      return this.configuration.getVaryingInfo(locationOrName).location;\n    }\n    const location = Number(locationOrName);\n    return Number.isFinite(location) ? location : -1;\n  }\n\n  // Need to avoid chrome bug where buffer that is already bound to a different target\n  // cannot be bound to 'TRANSFORM_FEEDBACK_BUFFER' target.\n  _bindBuffers() {\n    if (this.bindOnUse) {\n      for (const bufferIndex in this.buffers) {\n        const {buffer, byteSize, byteOffset} = this._getBufferParams(this.buffers[bufferIndex]);\n        this._bindBuffer(bufferIndex, buffer, byteOffset, byteSize);\n      }\n    }\n  }\n\n  _unbindBuffers() {\n    if (this.bindOnUse) {\n      for (const bufferIndex in this.buffers) {\n        this._bindBuffer(bufferIndex, null);\n      }\n    }\n  }\n\n  _bindBuffer(index, buffer, byteOffset = 0, byteSize) {\n    const handle = buffer && buffer.handle;\n    if (!handle || byteSize === undefined) {\n      // @ts-ignore\n      this.gl.bindBufferBase(GL.TRANSFORM_FEEDBACK_BUFFER, index, handle);\n    } else {\n      // @ts-ignore\n      this.gl.bindBufferRange(GL.TRANSFORM_FEEDBACK_BUFFER, index, handle, byteOffset, byteSize);\n    }\n    return this;\n  }\n\n  // RESOURCE METHODS\n\n  _createHandle() {\n    // @ts-ignore\n    return this.gl.createTransformFeedback();\n  }\n\n  _deleteHandle() {\n    // @ts-ignore\n    this.gl.deleteTransformFeedback(this.handle);\n  }\n\n  _bindHandle(handle) {\n    // @ts-ignore\n    this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, this.handle);\n  }\n}\n"],"mappings":"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"}